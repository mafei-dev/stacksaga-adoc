<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>StackSaga Reference Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
  
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction_to_microservices">1. Introduction To Microservices</a>
<ul class="sectlevel2">
<li><a href="#_get_started">1.1. Get Started</a></li>
<li><a href="#_microservice_architecture">1.2. Microservice Architecture</a></li>
<li><a href="#_what_are_microservices">1.3. What are microservices?</a></li>
<li><a href="#_database_per_service_pattern">1.4. Database per Service Pattern</a></li>
<li><a href="#_distributed_transaction">1.5. Distributed Transaction</a></li>
<li><a href="#_challenges_of_distributed_transaction">1.6. Challenges of Distributed Transaction</a></li>
</ul>
</li>
<li><a href="#introduction_to_saga">2. Introduction to Saga</a>
<ul class="sectlevel2">
<li><a href="#what_is_saga_architecture_pattern">2.1. What Is Saga Architecture Pattern?</a></li>
<li><a href="#saga_orchestration_pattern">2.2. Saga Orchestration Pattern</a></li>
<li><a href="#eventual_consistency">2.3. Eventual Consistency</a></li>
<li><a href="#classification_of_saga_transactions">2.4. Classification of SAGA transactions</a>
<ul class="sectlevel3">
<li><a href="#fully_success_transaction">2.4.1. <span class="icon green"><i class="fa fa-circle"></i></span> Fully Success</a></li>
<li><a href="#revert_success_transaction">2.4.2. <span class="icon yellow"><i class="fa fa-circle"></i></span> Compensation Success</a></li>
<li><a href="#revert_failed_transaction">2.4.3. <span class="icon red"><i class="fa fa-circle"></i></span> Compensation Failed</a></li>
<li><a href="#_classification_of_saga_translations_summary">2.4.4. Classification of SAGA translations — Summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#stacksaga_architecture">3. StackSaga Architecture</a>
<ul class="sectlevel2">
<li><a href="#what_is_stacksaga">3.1. Introduction To StackSaga</a></li>
<li><a href="#stacksaga_high_level">3.2. StackSaga in High-level</a></li>
<li><a href="#key_processes_of_ecosystem">3.3. Key Processes of ecosystem</a></li>
<li><a href="#stack_saga_admin_connect_with_event-store">3.4. Admin Communication With Event-store</a></li>
<li><a href="#stacksaga_components">3.5. StackSaga Components</a></li>
<li><a href="#SEC">3.6. Saga execution coordinator (SEC)</a></li>
<li><a href="#event_store">3.7. Event Store</a>
<ul class="sectlevel3">
<li><a href="#one_event_store_per_service">3.7.1. One Event-Store Per Service.</a></li>
<li><a href="#single_event_store_for_all_services">3.7.2. Single Event-Store For All Services.</a></li>
<li><a href="#the_requirement_of_the_event_store">3.7.3. The requirement of the event-store</a></li>
<li><a href="#_what_are_the_reasons_for_saving_the_states_in_the_event_store">3.7.4. What are the reasons for saving the states in the event-store?</a></li>
</ul>
</li>
<li><a href="#aggregator_architecture">3.8. Aggregator</a></li>
<li><a href="#executor_architecture">3.9. Executor</a>
<ul class="sectlevel3">
<li><a href="#query_executor_architecture">3.9.1. Query Executor</a></li>
<li><a href="#command_executor_architecture">3.9.2. Command Executor</a></li>
<li><a href="#_how_executors_behave_in_the_application">3.9.3. How Executors Behave In The Application.</a></li>
</ul>
</li>
<li><a href="#aggregator_and_executors">3.10. Relationship between Aggregator and Executors</a>
<ul class="sectlevel3">
<li><a href="#aggregator_usage_with_executor">3.10.1. How the Aggregator is used through the Executors</a></li>
</ul>
</li>
<li><a href="#aggregator_versioning">3.11. Aggregator Versioning</a></li>
<li><a href="#version_casting_architecture">3.12. Version Casting</a>
<ul class="sectlevel3">
<li><a href="#aggregator_oriented_casting_architecture">3.12.1. Aggregator-Oriented casting</a></li>
<li><a href="#aggregator_oriented_up_casting">3.12.2. Aggregator-Oriented Up-Casting</a></li>
<li><a href="#aggregator_oriented_down_casting">3.12.3. Aggregator-Oriented Down-Casting</a></li>
<li><a href="#executor_oriented_casting_architecture">3.12.4. Executor-Oriented Casting</a></li>
<li><a href="#_up_casting">3.12.5. up-casting</a></li>
</ul>
</li>
<li><a href="#dual_consistency_problem_of_sec_in_microservice">3.13. Dual-Consistency problem of SEC in microservice.</a>
<ul class="sectlevel3">
<li><a href="#how_execution_chunk_protection_works">3.13.1. How <strong>Execution Chunk Protection Mechanism</strong> works</a></li>
<li><a href="#execution_chunk_protection_mechanism_with_the_help_of_eureka_service_registry">3.13.2. Execution chunk protection mechanism with the help of eureka service registry.</a></li>
<li><a href="#stacksaga_discovery_configuration_properties">3.13.3. StackSaga Discovery Configuration Properties</a></li>
</ul>
</li>
<li><a href="#replay_transaction">3.14. Transaction Replay.</a></li>
<li><a href="#stack_saga_transaction_type">3.15. StackSaga Transaction Types</a>
<ul class="sectlevel3">
<li><a href="#fully_success_transaction_scenario">3.15.1. <span class="icon green"><i class="fa fa-circle"></i></span> Fully Success</a></li>
<li><a href="#revert_success_transaction_scenario">3.15.2. <span class="icon yellow"><i class="fa fa-circle"></i></span> Compensation Success</a></li>
<li><a href="#revert_failed_transaction_scenario">3.15.3. <span class="icon red"><i class="fa fa-circle"></i></span> Compensation Failed</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#stacksaga_admin_index">4. StackSaga Admin</a>
<ul class="sectlevel2">
<li><a href="#setup_the_service">4.1. Set up The Service</a>
<ul class="sectlevel3">
<li><a href="#stacksaga_admin_docker_image">4.1.1. StackSaga Admin Docker Image</a></li>
<li><a href="#stacksaga_admin_jar">4.1.2. StackSaga Admin Jar</a></li>
<li><a href="#stacksaga_admin_source">4.1.3. StackSaga Admin Source Code</a></li>
</ul>
</li>
<li><a href="#dashboard_initialize">4.2. Initialize Dashboard</a></li>
<li><a href="#create_api_gateway_user">4.3. Create API Gateway User</a></li>
<li><a href="#create_service_user">4.4. Create Service User</a></li>
<li><a href="#create_operator_user">4.5. Create Operator User</a></li>
</ul>
</li>
<li><a href="#stacksaga_core_index">5. StackSaga Starter Core</a>
<ul class="sectlevel2">
<li><a href="#creating_aggregator_class">5.1. Creating Aggregator Class</a></li>
<li><a href="#saga_serializable">5.2. Creating SagaSerializable Class for Aggregator</a></li>
<li><a href="#aggregator_mapper_implementation">5.3. Custom Aggregator Mapper</a></li>
<li><a href="#complex_aggrgator">5.4. Full Aggregator implementation.</a></li>
<li><a href="#aggregator_serialization_and_deserialization">5.5. Aggregator Serialization And Deserialization</a></li>
<li><a href="#aggregators_event_casting">5.6. Aggregator&#8217;s Event Casting</a>
<ul class="sectlevel3">
<li><a href="#collect_missing_properties">5.6.1. Collect Missing properties</a></li>
</ul>
</li>
<li><a href="#saga_executors">5.7. Saga Executors.</a>
<ul class="sectlevel3">
<li><a href="#query_executor">5.7.1. Query Executor.</a></li>
<li><a href="#command_executor">5.7.2. Command Executor.</a></li>
<li><a href="#revert_before_executor">5.7.3. Revert Before Executor.</a></li>
<li><a href="#revert_after_executor">5.7.4. Revert After Executor.</a></li>
</ul>
</li>
<li><a href="#_processstack">5.8. ProcessStack</a></li>
<li><a href="#retryable_executor_exception">5.9. RetryableExecutorException</a></li>
<li><a href="#non_retryable_executor_exception">5.10. NonRetryableExecutorException</a></li>
<li><a href="#usage_of_exceptions">5.11. Usage of Executors[Q&amp;C] With Exceptions </a></li>
<li><a href="#saga_exception_annotation">5.12. @SagaException Annotation </a></li>
<li><a href="#saga_revert_hint_store">5.13. RevertHintStore</a></li>
<li><a href="#saga_event_handler">5.14. Saga Execution Event Listener </a></li>
<li><a href="#saga_template">5.15. SagaTemplate&lt;A&gt;</a></li>
<li><a href="#saga_trash_listener">5.16. TrashFileListener</a></li>
<li><a href="#custom_thread_pool_configuration">5.17. Custom Thread-pool configuration</a>
<ul class="sectlevel3">
<li><a href="#saga_discovery_transaction_task_executor">5.17.1. Saga Discovery Transaction TaskExecutor</a></li>
<li><a href="#saga_event_task_executor">5.17.2. Saga Event TaskExecutor</a></li>
<li><a href="#saga_admin_task_executor">5.17.3. Saga Admin TaskExecutor</a></li>
<li><a href="#saga_discovery_file_task_executor">5.17.4. Saga Discovery File TaskExecutor</a></li>
<li><a href="#saga_discovery_retry_transaction_task_executor">5.17.5. Saga Discovery Retry Transaction TaskExecutor</a></li>
</ul>
</li>
<li><a href="#connect_admin">5.18. Connect Admin</a>
<ul class="sectlevel3">
<li><a href="#custom_admin_connect_resttemplate_configuration">5.18.1. Custom Admin Connector configuration</a></li>
</ul>
</li>
<li><a href="#service_communication">5.19. Internal Service Communication</a>
<ul class="sectlevel3">
<li><a href="#eureka_configuration_for_stacksaga">5.19.1. Eureka configuration for StackSaga</a>
<ul class="sectlevel4">
<li><a href="#custom_service_communication_resttemplate_configuration">5.19.1.1. Custom Service Communication configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#stacksaga_starter_db_index">6. StackSaga Starter DB</a></li>
<li><a href="#stacksaga_starter_discovery_index">7. StackSaga Starter Discovery</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="resources/img/stacksaga-logo.jpg" alt="StackSaga Logo" width="300">
</div>
</div>
<!-- toc disabled -->
<style>
.rounded-number {
    background-color: #0047b3;
    color: white;
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 75%;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.5rem;
}
</style>
</div>
</div>
<div class="sect1">
<h2 id="_introduction_to_microservices"><a class="anchor" href="#_introduction_to_microservices"></a>1. Introduction To Microservices</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_get_started"><a class="anchor" href="#_get_started"></a>1.1. Get Started</h3>
<div class="paragraph">
<p>In this section, you will get the architecture of this framework.
Other than that, you will get what are the limitations you have to face when you are going to use microservice architecture and how overcome those difficulties by using StackSAGA framework.</p>
</div>
</div>
<div class="sect2">
<h3 id="_microservice_architecture"><a class="anchor" href="#_microservice_architecture"></a>1.2. Microservice Architecture</h3>
<div class="paragraph">
<p>Before dive in to the framework, let&#8217;s have the basic idea of microservice architecture.
A microservice' architecture consists of a collection of small, autonomous services.
Each service is self-contained and should implement a single business capability within a bounded context.
A bounded context is a natural division within a business and provides an explicit boundary within which a domain model exists.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_are_microservices"><a class="anchor" href="#_what_are_microservices"></a>1.3. What are microservices?</h3>
<div class="paragraph">
<p>Microservices are a modern approach to software whereby application code is delivered in small, manageable pieces, independent of others.
<a href="https://spring.io/microservices">Read more through spring microservices.</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_database_per_service_pattern"><a class="anchor" href="#_database_per_service_pattern"></a>1.4. Database per Service Pattern</h3>
<div class="paragraph">
<p>One of the benefits of microservice architecture is that it lets us choose the technology stack per service.
For instance, we can decide to use a relational database for service A and opt for a NoSQL database for service B. This model lets the services manage domain data independently on a data store that best suites its data types and schema.
Further, it also lets the service scale its datastore on-demand and insulates it from the failures of other services.
However, at times a transaction can span across multiple services, and ensuring data consistency across the service database is a challenge.
In the next section, let us examine the challenge of distributed transaction management with an example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_distributed_transaction"><a class="anchor" href="#_distributed_transaction"></a>1.5. Distributed Transaction</h3>
<div class="paragraph">
<p>To demonstrate the use of distributed transactions, we’ll take an example of an e-commerce application that processes online orders and is implemented with microservice architecture.
There is a microservice to create the orders, one that processes the payment, another that updates the inventory and the last one that delivers the order.
Each of these microservices performs a local transaction to implement the individual functionalities:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/distributed-transaction.png" alt="distributed transaction" height="300">
</div>
</div>
<div class="paragraph">
<p>To ensure a successful order processing service, all four microservices must complete the individual local transactions. If any of the microservice fails to complete its local transaction, all the completed preceding transactions should roll back to ensure data integrity. This is an example of a distributed transaction as the transaction boundary crosses multiple services and databases.</p>
</div>
</div>
<div class="sect2">
<h3 id="_challenges_of_distributed_transaction"><a class="anchor" href="#_challenges_of_distributed_transaction"></a>1.6. Challenges of Distributed Transaction</h3>
<div class="paragraph">
<p>In the previous section, we’ve provided a real-life example of a distributed transaction. Distributed transactions in a microservice architecture pose two key challenges. The first one is maintaining ACID. To ensure the correctness of a transaction, it must be an atomic, consistent, isolated, and durable (ACID). The atomicity ensures that all or none of the steps of a transaction should complete. Consistency takes data from one valid state to another valid state. Isolation guarantees that concurrent transactions should produce the same result that sequentially transactions would have produced. Lastly, durability means that committed transactions remain committed irrespective of any type of system failure. In a distributed transaction scenario, as the transaction spans several services, it always remains a key concern to ensure ACID. The second one is managing the transaction isolation level. It specifies the amount of data that is visible in a transaction when the other services access the same data simultaneously. In other words, if one object in one of the microservices is persisted in the database while another request reads the data, should the service return the old or new data?</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction_to_saga"><a class="anchor" href="#introduction_to_saga"></a>2. Introduction to Saga</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what_is_saga_architecture_pattern"><a class="anchor" href="#what_is_saga_architecture_pattern"></a>2.1. What Is Saga Architecture Pattern?</h3>
<div class="paragraph">
<p>The Saga architecture pattern provides transaction management using a sequence of local transactions. A local transaction is the unit of work performed by a saga participant. Every operation that is part of the Saga can be rolled back by a compensating transaction. Further, the Saga pattern guarantees that either all operations are complete successfully or the corresponding compensation transactions are run to undo the work previously completed. In the Saga pattern, a compensating transaction must be important and retryable. These two principles ensure that a transaction can be managed without any manual intervention. The Saga Execution Coordinator (SEC) ensures guarantees these principles:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/compensating-transaction.svg" alt="distributed transaction" height="300">
</div>
</div>
<div class="paragraph">
<p>The above diagram shows how to visualize the Saga pattern for the previously discussed online order processing scenario.</p>
</div>
</div>
<div class="sect2">
<h3 id="saga_orchestration_pattern"><a class="anchor" href="#saga_orchestration_pattern"></a>2.2. Saga Orchestration Pattern</h3>
<div class="paragraph">
<p>In the Orchestration pattern, a single orchestrator is responsible for managing the overall transaction status. If any of the microservices encounters a failure, then the orchestrator is responsible for invoking the necessary compensating transactions. The Saga orchestration pattern is useful for brownfield microservice application development architecture. In other words, this pattern is suitable if we already have a set of microservices and would like to implement the Saga pattern in the application. We need to define the appropriate compensating transactions to proceed with this pattern.</p>
</div>
</div>
<div class="sect2">
<h3 id="eventual_consistency"><a class="anchor" href="#eventual_consistency"></a>2.3. Eventual Consistency</h3>
<div class="paragraph">
<p>Eventual consistency is a technique that ensures data consistency and availability by asynchronous communication and ensuring that when an error occurs in a specific process, the error will be resolved eventually without having to roll back the whole process.</p>
</div>
</div>
<div class="sect2">
<h3 id="classification_of_saga_transactions"><a class="anchor" href="#classification_of_saga_transactions"></a>2.4. Classification of SAGA transactions</h3>
<div class="paragraph">
<p>According to the behaviors of the transaction, we can mainly identify 3 transaction types that can be happened when we use saga.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Fully success transaction</strong></p>
</li>
<li>
<p><strong>Rollback/Compensation/Revert success transaction</strong></p>
</li>
<li>
<p><strong>Rollback/Compensation/Revert failed transaction</strong></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="fully_success_transaction"><a class="anchor" href="#fully_success_transaction"></a>2.4.1. <span class="icon green"><i class="fa fa-circle"></i></span> Fully Success</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/transaction-success.svg" alt="distributed transaction" height="300">
</div>
</div>
<div class="paragraph">
<p>As we discussed earlier, we had used a number of microservices for doing one single execution.
Just assume we have used 5 microservices to be executed and all of them have been worked without any errors.
Then there is no revert processes have been executed.
That means all the microservices are up and running and there haven&#8217;t been occurred exceptions internally inside each microservice.</p>
</div>
</div>
<div class="sect3">
<h4 id="revert_success_transaction"><a class="anchor" href="#revert_success_transaction"></a>2.4.2. <span class="icon yellow"><i class="fa fa-circle"></i></span> Compensation Success</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/rollback-compensation-revert-success-transaction.svg" alt="revert success transaction" height="300">
</div>
</div>
<div class="paragraph">
<p>In this time, An exception has occurred when one of microservices get execute.
Just assume the coordinator has been executed 3 microservices successfully, but at the 4th one, an error has occurred due to a network exception or whatever internal exception that the microservices have been thrown.
Now the coordinator has to execute revert function regarding all microservices that executed earlier.
So the coordinator will start to execute all the revert functions one by one as a sequence.
If those revert functions have been executed successfully, these kinds of transactions are going to these types.
Simply we did a set of transactions but unfortunately got an error, but all the revert processes are done successfully.</p>
</div>
</div>
<div class="sect3">
<h4 id="revert_failed_transaction"><a class="anchor" href="#revert_failed_transaction"></a>2.4.3. <span class="icon red"><i class="fa fa-circle"></i></span> Compensation Failed</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/rollback-compensation-revert-failed-transaction.svg" alt="rollback compensation revert failed transaction" height="300">
</div>
</div>
<div class="paragraph">
<p>In this time, the coordinator tries to execute the transactions one by one.
But while doing the execution, an error occurred after doing some executions, and the coordinator gets started to execute all the revert processes that regard to the microservices that previously executed.
But unfortunately, while doing the revert executions, an error gets occurred because of a network issues.
(Network issues means it can be happened because there is no endpoint in active at that time or kind of actual network problems)</p>
</div>
</div>
<div class="sect3">
<h4 id="_classification_of_saga_translations_summary"><a class="anchor" href="#_classification_of_saga_translations_summary"></a>2.4.4. Classification of SAGA translations — Summary</h4>
<div class="paragraph">
<p><strong>Fully success transaction</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/fully-success-transaction-summary.svg" alt="Fully Success Transaction Summary" height="300">
</div>
</div>
<div class="paragraph">
<p><strong>Rollback/Compensation/Revert success transaction</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/revert-success-transaction-summary.svg" alt="Revert Success Transaction Summary" height="300">
</div>
</div>
<div class="paragraph">
<p><strong>Rollback/Compensation/Revert failed transaction</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/revert-failed-transaction-summary.svg" alt="Revert Failed Transaction Summary" height="300">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stacksaga_architecture"><a class="anchor" href="#stacksaga_architecture"></a>3. StackSaga Architecture</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what_is_stacksaga"><a class="anchor" href="#what_is_stacksaga"></a>3.1. Introduction To StackSaga</h3>
<div class="paragraph">
<p>StackSaga is an echo system that helps you to manage and monitor your distributed transactions in microservice' architecture.</p>
</div>
<div class="paragraph">
<p>As you saw in the &#8230;&#8203;. Section, There&#8217;s a distributed transaction problem in microservice' architecture.
So managing distributed transaction is very complicated without a framework.
StackSaga Saga provides a better and resilient architecture as an <strong>orchestration engine framework</strong> to overcome that problem with a lot of additional features as well.</p>
</div>
<div class="paragraph">
<p>StackSaga mainly consists of two parts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong><a href="#stacksaga_admin_index">StackSaga Admin</a>.</strong><br>
StackSaga admin mainly provides the monitoring facilities of the transactions and manages the security.</p>
</li>
<li>
<p><strong>StackSaga Framework</strong>.</p>
<div class="ulist">
<ul>
<li>
<p>StackSaga Framework provides orchestration engine support for your distributed transactions in your service.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Quick Understanding:</strong> <a id="quick_understanding_example"></a></p>
</div>
<div class="paragraph">
<p>Just imagine that you have a business domain for placing an order in microservice architecture.
So you can have multiple services, and you have to visit all over the services to complete the place-odder transaction.</p>
</div>
<div class="paragraph">
<p>The services might be as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Order-service</p>
</li>
<li>
<p>Payment-service</p>
</li>
<li>
<p>Cart-service</p>
</li>
<li>
<p>Delivery-Service and many more.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>IF you execute the place order process, you have to go through each and every service one by one after competing each of them.
There is no issue with that if the entire process is completed successfully all the time.
But in microservice architecture, it is not possible and there is a possibility to have an at least connection issue.
Just think all the past services are done successfully, but the last execution is failed due to insufficient balance or payment-service&#8217;s failure.
Then you have to revert (compensation-transaction) all the past executions <strong>one by one as the same-order</strong>
that those services were executed to overcome the eventual consistency according to the Saga design pattern.
It is very complicated if you are going to do manually.
Other than that, just imagine you are able to handle and bare the last failed execution, and you started to revert all the past executions one by one.
Just imagine very unfortunately, you are getting a connection error at the last revert process.</p>
</div>
<div class="paragraph">
<p><strong>Oops!</strong>
Now your in a big trouble with your data consistency.
Because your both transaction Forward-process and Revert-process are failed at this moment.
You can do nothing in this kind of situation.</p>
</div>
<div class="paragraph">
<p>You were unable to reach the target end execution to forward.
Therefore, you stated revert-process for all the past executions one by one (Last-In, First-Out order [<strong>LIFO</strong>] ).
But unfortunately, You were unable to reach the target final revert as well due to a network issue.</p>
</div>
<div class="paragraph">
<p>Here you can see What happened to your place-order transaction with a diagram.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/revert-failed-transaction-intro.svg" alt="StackSaga revert failed transaction" height="300">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You Started the place-order transaction there.</p>
</li>
<li>
<p>Stopped the place-order transaction due to not sufficient balance.</p>
</li>
<li>
<p>Your target transaction ending for a successful transaction.</p>
</li>
<li>
<p>Started revert process due the transaction was stopped unsuccessfully.</p>
</li>
<li>
<p>The revert process was stopped due to a connection error.</p>
</li>
<li>
<p>The target revert process ending for a successful revert transaction.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>How StackSaga framework helps to overcome this problem?</strong></p>
</div>
<div class="paragraph">
<p>StackSaga provides a <strong>Codespaces</strong> (Those called as <a href="#command_executor_architecture">Command Executor</a>,<a href="#query_executor_architecture">Query Executor</a>) to provide your atomic operations that you did same in the place-order transaction.
The only thing that you have to do is to provide the execution-process inside the <strong>Codespaces</strong> and notify the exception type whether it is retryable or not.
Then the StackSaga engine will invoke each atomic transaction until the entire transaction gets succeeded (revert success or full process success).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-codespacess.drawio.svg" alt=" Stacksaga Executors" height="300">
</div>
</div>
<div class="paragraph">
<p>In the above diagram, you can see the Codespaces for each atomic transaction.
You already might have the code portion for making the requests to other services.
In StackSaga, you can call those methods inside the <strong>Codespaces</strong>.
Then StackSaga coordinator will invoke your code portion through the <strong>Codespaces</strong>.
StackSaga does not involve your request.
Therefore, you don&#8217;t want to really on specific protocol, and you can use any protocol for making request.
At least the endpoints should not be within the same <a href="https://spring.io/microservices">spring cloud ecosystem</a>.
The endpoints can be anything external or within the ecosystem.
The only thing that you want to do is make the request part of each atomic transaction and warp up with <strong>Codespaces</strong> (<a href="#executor_architecture">executors</a>).</p>
</div>
<div class="paragraph">
<p>StackSaga orchestration engine follows these concepts behind the scenes.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Saga design pattern</p>
</li>
<li>
<p>Event sourcing</p>
</li>
<li>
<p>Eventual consistency.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="stacksaga_high_level"><a class="anchor" href="#stacksaga_high_level"></a>3.2. StackSaga in High-level</h3>
<div class="paragraph">
<p>In the <a href="#what_is_stacksaga">introduction section</a>, We got a clear idea of how microservice architecture works, and what are the challenges that we have to face when implementing the microservice in traditional way.</p>
</div>
<div class="paragraph">
<p>Here, we are going to see how the StackSaga works together with typical microservice architecture.
It shows how StackSaga does impact on the default <a href="https://spring.io/microservices">spring boot microservice architecture</a>.</p>
</div>
<div class="paragraph">
<p>For your convenience, both <strong>Spring Microservice Architecture</strong> and <strong>Spring Microservice Architecture With StackSaga</strong> diagrams have been added here.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Spring Microservice Architecture</strong> <a id="spring_microservice_architecture"></a><br></p>
<div class="imageblock">
<div class="content">
<img src="resources/img/microservice-high-level-diagram.svg" alt="Microservice High Level Diagram" height="300">
</div>
</div>
</li>
<li>
<p><strong>Spring Microservice Architecture With StackSaga</strong></p>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-high-level-diagram.svg" alt="StackSaga High-level architecture" height="300">
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>After adding stack saga in the microservice architecture, you can see there are some additional components in the high-level architecture diagram.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the diagram, the <strong>Gray</strong> color components and lines are related to the typical microservice architecture, and additional stacksaga related components and lines have been colored by <strong>Green</strong> color.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at all the components and how they are interacted with each other.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>At first glance, you can see a major difference in database architecture.
The reason is StackSaga <a href="#SEC">SEC</a> uses <strong>event sourcing</strong> for managing your <a href="#aggregator_architecture">aggregator state</a> for each <a href="#executor_architecture">executor</a>.
In brief, StackSaga internally uses a database to string your execution data as events.
Therefore, If you are using StackSaga, you have to provide a database as the <a href="#event_store">event-store</a>.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Even though the diagram shows event-store per service, It can be configured as a single event-store for all services if the application is currently not a large one. <a href="#event_store">Read more</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is recommended to use one of the StackSaga-DB implementations equal to the primary database for the particular service.
Because, you don&#8217;t need to configure another separate database and complicate the architecture.<br>
As an example, If the order-service uses <strong>MYSQL</strong> databases as the <strong>primary database</strong>, you can use the <code>StackSaga-MYSQL</code> implementation for the event-store.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The event-store is accessed by the StackSaga framework.
Therefore, The <code>StackSaga-Core</code> library (StackSaga <a href="#SEC">SEC</a> is located in this library) should be added to your application.</p>
</div>
</li>
<li>
<p>Even though it is enough for the event-sourcing, StackSaga provides more additional functionalities like avoiding <a href="#dual_consistency_problem_of_sec_in_microservice">Dual-Consistency Problem</a>, <a href="#stacksaga_admin">Monitoring Trace,</a> etc.
Therefore, another library should be added to your application called <code>StackSaga-Discovery</code>.
It will interact with your <strong>service-registry</strong> and get to know about the service availability.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, StackSaga only supports for <a href="https://spring.io/projects/spring-cloud-netflix">Eureka Service Registry</a>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Next, Let&#8217;s have a look at <a href="#stacksaga_admin">StackSaga Admin</a>.
Admin provides a lot of facilities in the framework.
Primarily feature is monitoring and tracking the transaction&#8217;s flow and trace.
For monitoring your transactions, Admin should be able to retrieve the transaction data from each event-store.
Internally, <code>StackSaga-Discovery</code> library provides and exposes the endpoints for that.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>According to the high-level architecture diagram and the brief explanation, you can identify one application and 4 libraries are involved for StackSaga.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>StackSaga-Core</code> (library).</p>
</li>
<li>
<p><code>StackSaga-Discovery</code> (library).</p>
</li>
<li>
<p><code>StackSaga-DB</code> (library).</p>
</li>
<li>
<p><code>StackSaga-Admin-Server</code> (Application).</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/architecture-stacksaga-products.drawio.svg" alt="StackSaga High-level architecture" height="300">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StackSaga-Core</code>, <code>StackSaga-DB</code> and <code>StackSaga-Discovery</code> dependencies are used for the individual service that you want to use the service as an <strong>orchestrator</strong>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
No need to add StackSaga for all the services in the ecosystem.
It can be added freely only to the services that you want to use.
If There is no any complex business domain in some services, there is no point in adding StackSaga for that particular service and keep it as it is in the ecosystem.
</td>
</tr>
</table>
</div>
</li>
<li>
<p><code>StackSaga-Admin-Server</code> Can be run as a standalone server.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, StackSaga-Admin does support only for MYSQL.
It does not bother other services.
StackSaga-Admin&#8217;s Database is used only for saving the <strong>User&#8217;s-Credentials</strong> and the <strong>Terminated Transactions'</strong> metadata.
<mark>Other data that you can see in the StackSaga-Admin dashboard are obtained from each service&#8217;s event-store endpoints.
</mark>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>We had a quit a simple idea over this high-level overview.
It is recommended to fallow the following architectures in detailed to have a better understanding.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How <a href="#SEC">SEC</a> does work with help of <code>StackSaga-Core</code> and <code>StackSaga-DB</code> inside the individual services.</p>
<div class="paragraph">
<p><a href="#SEC">Read in detailed</a></p>
</div>
</li>
<li>
<p>How StackSaga Overcomes the <a href="#dual_consistency_problem_of_sec_in_microservice">Dual-Consistency Problem</a> with help of <code>StackSaga-Discovery</code>.</p>
<div class="paragraph">
<p><a href="#dual_consistency_problem_of_sec_in_microservice">Read in detailed</a></p>
</div>
</li>
<li>
<p>How StackSaga Admin communicates with each service&#8217;s event-store endpoints with the help of API-Gateway</p>
<div class="paragraph">
<p><a href="#SEC">Read in detailed</a></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="key_processes_of_ecosystem"><a class="anchor" href="#key_processes_of_ecosystem"></a>3.3. Key Processes of ecosystem</h3>
<div class="paragraph">
<p>To understand the relation of those components whole process can be summarised as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Initialize the admin server with super admin.</p>
<div class="ulist">
<ul>
<li>
<p>As the first step, you have to create initialize the admin server.
See the initialization steps.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Register API gateways with admin server</p>
<div class="ulist">
<ul>
<li>
<p>To connect the StackSaga, your API gateway should provide an API-gateway-user credentials.
Therefore, super Admin should create a user with API gateway authorization (role).
After creating the API gateway user, the api gateway can be run because StackSaga Shield will check your credentials connecting with the admin server.
For this process, StackSaga server and StackSaga Shield were involved.
See the implementation to see more in detail.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Register each microservice with admin server.</p>
<div class="ulist">
<ul>
<li>
<p>To register the services in the admin server, the super admin or admin has to create a user for service with service privileges.
As a best-practice, the StackSaga team recommends you to create one user for one service group.
(A service group can have multiple instances, but the service names are the same.) For instance, order-service should have a service user called order-service-general-user.
And payment service should have a service user called payment-service-general-user.
At the start-up, the connector will verify your service credentials and let you the access to register and run the service.
For this process, StackSaga Server and StackSaga Connector were involved.
See the implementation to see more in detail.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Execute a transaction.</p>
<div class="ulist">
<ul>
<li>
<p>This is the main part that you are willing to see.
The request comes through the API gateway as usual, and the StackSaga coordinator will obtain the request data that you pass, and the coordinator will handle all the process and executions as you have guided the framework.
For this process only StackSaga coordinator was involved.
Read the implementation Or read how stack saga execution types work to see more, in detail.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Monitor transactions execution data.</p>
<div class="ulist">
<ul>
<li>
<p>To see the execution data, you should have to have a user account on the admin server.
If you are the super admin, the super admin can see all the details.
But as a best-practice, make sure to create a separate individual account for each user that wat to access the admin server to see the transaction data.
After login to the dashboard, you have to give the access path of the API gateway that you want to access the services.
You will be able to see the transaction data.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For this process, StackSaga server, StackSaga Shield and StackSaga Connector were involved.</p>
</div>
</div>
<div class="sect2">
<h3 id="stack_saga_admin_connect_with_event-store"><a class="anchor" href="#stack_saga_admin_connect_with_event-store"></a>3.4. Admin Communication With Event-store</h3>
<div class="imageblock">
<div class="content">
<img src="resources/img/architecture_stacksaga_how_admin_dashboard_access_stacksaga_endpoint.drawio.svg" alt="StackSaga High-level architecture" height="300">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Admin sends the request to access the event-store data from the admin-dashboard (<code>/stacksaga/**</code>) with the admin-user credentials.</p>
</li>
<li>
<p>spring API-gateway catches the request and check the mapping. if the request is starting prefixed with <code>/stacksaga</code>, the request goes through the <strong>StackSaga Shield</strong>'s filter. then the filter will communicate with the stacksaga admin server with the admin-user credentials and also with the Api-Gateway-user credentials.</p>
</li>
<li>
<p>StackSaga admin received the request and checks the both credentials.</p>
</li>
<li>
<p>StackSaga admin sends the response the credentials are valid or not.
v If the request credentials are validated, Api-Gateway sends the request to one of available service instances (x-Service).<br></p>
</li>
<li>
<p>The service will rerun the data set to the incoming request.
(The endpoint will be provided by the StackSaga connector.)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="stacksaga_components"><a class="anchor" href="#stacksaga_components"></a>3.5. StackSaga Components</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#stacksaga_admin_index">StackSaga Admin</a></p>
</li>
<li>
<p><a href="#stacksaga_core_index">StackSaga Starter Core</a></p>
</li>
<li>
<p><a href="#stacksaga_starter_db_index">StackSaga Starter DB</a></p>
</li>
<li>
<p><a href="#stacksaga_starter_discovery_index">StackSaga Starter Discovery</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="SEC"><a class="anchor" href="#SEC"></a>3.6. Saga execution coordinator (SEC)</h3>
<div class="paragraph">
<p>The Saga Execution Coordinator (SEC) is the core component for implementing a successful Saga flow.
It maintains a Saga log that contains the sequence of events of a particular flow.
If a failure occurs within any of the components, the SEC queries the logs and helps identify which components are impacted and in which sequence the compensating transactions must be executed.
Essentially, the SEC helps maintain an eventually consistent state of the overall process.</p>
</div>
<div class="paragraph">
<p>If the SEC component itself fails, it can read the SEC logs when coming back up to identify which of the components are successfully rolled back, identify which ones were pending, and start calling them in reverse chronological order.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stores &amp; interpret a Saga’s state machine</p>
</li>
<li>
<p>Executes the Requests of a Saga by talking to other services</p>
</li>
<li>
<p>Handle failure recovery by executing Compensating Requests</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-e-store-example-SEC.drawio.svg" alt="StackSaga  Saga Execution Coordinator (SEC)" height="300">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to see how SEC works for each transaction mode in detail, please refer <a href="#stack_saga_transaction_type">StackSaga Transaction Types</a>.
It will give you a better understanding of StackSaga framework as well.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="event_store"><a class="anchor" href="#event_store"></a>3.7. Event Store</h3>
<div class="paragraph">
<p>Event-store is the location that StackSaga stores the data Relevant to the transaction execution as well as the storing the metadata of the components that you provided like <strong>aggregator details</strong>, <strong>executor details</strong>, <strong>application version details</strong> etc. all the data you can see through the <a href="#stacksaga_admin">StackSaga Admin dashboard</a>.
You can configure the database for the event-store as the pattern of database per service.
Otherwise, you can provide one event-store for all services.
But as the best practice, event-store per service is recommended.
You can define a separate schema for event-store by providing the configurations.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>One Event-Store Per Service.</p>
</li>
<li>
<p>One Common Event-Store For All Services.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="one_event_store_per_service"><a class="anchor" href="#one_event_store_per_service"></a>3.7.1. One Event-Store Per Service.</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-event-store-per-service.drawio.svg" alt="StackSaga Event Store Per Service" height="300">
</div>
</div>
</div>
<div class="sect3">
<h4 id="single_event_store_for_all_services"><a class="anchor" href="#single_event_store_for_all_services"></a>3.7.2. Single Event-Store For All Services.</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-one-event-store-for-all-services.drawio.svg" alt="StackSaga Event Store For All Service" height="300">
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_requirement_of_the_event_store"><a class="anchor" href="#the_requirement_of_the_event_store"></a>3.7.3. The requirement of the event-store</h4>
<div class="paragraph">
<p>StackSaga framework provides the SEC capabilities.
Then the framework has to store each execution data (aggregator state and the transaction information like that each sub transaction was failed or success, etc.) The interesting part is how the framework saves each state of the whole transaction process.
As the initial step, the transaction is saved in the event store with initial data that you provided with the relevant aggregator.
After the saving the INIT step, the first executor is invoked and after invoking the executor, the framework saves the new updated aggregator state in the event store.
Likewise, after all and every steps the updated aggregator state and the execution state are saved in the event-store.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_are_the_reasons_for_saving_the_states_in_the_event_store"><a class="anchor" href="#_what_are_the_reasons_for_saving_the_states_in_the_event_store"></a>3.7.4. What are the reasons for saving the states in the event-store?</h4>
<div class="ulist">
<ul>
<li>
<p><strong>To retry purpose.</strong></p>
<div class="paragraph">
<p>Any kind of execution can retry if the execution is failed due to a <a href="#retryable_executor_exception">retryable-exception</a> like network exception.
Because if an execution is failed due to a network error, it is not fair that it is treated as an exception in the microservice architecture.
Because one transaction consists of multiple individual transactions and any time one service may have gone down.
Therefore, retrying the execution is one of the main features that StackSaga provides.
StackSaga always considers the <a href="#eventual_consistency">eventual consistency</a>.</p>
</div>
</li>
<li>
<p><strong>To see each and every step and their changes by using the StackSaga <a href="#stacksaga_admin">Admin Dashboard</a>.</strong></p>
<div class="paragraph">
<p>You can see how the aggregator was changed while each sub process of the transaction which transactions were failed or which transaction is pending to the execution and which transaction has been successfully done, etc.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aggregator_architecture"><a class="anchor" href="#aggregator_architecture"></a>3.8. Aggregator</h3>
<div class="paragraph">
<p>An <strong>aggregator</strong> is the main location that all the data should be kept for the entire transaction.
According to the StackSaga example, the entire process has set pf sub processes.
Create order, check user activeness, make payment, increase points and dispatch the order.
While those processes, you have to keep some data regarding the transaction.
For instance, the process is started from creating order.
After creating the order, you have a data to be kept.
As a response, you will get the order id.
You have to keep it, and you have to reuse it in your whole process.
After creating the order, you check the user activeness.
Then the user service is called and get the response of user&#8217;s activeness and keep that data as user is active at the time of the process started.
Likewise, each and every process will return you to data.
Those data you have to keep in one location.
That location called as the aggregator.
At the start, you have to declare the variables, and after doing each process, you can update the values in the aggregator.
On the other hand, we can say it is the data bucket that you bring the data to each executor.</p>
</div>
<div class="paragraph">
<p>Another special thing is that the aggregator is used as the key of your entire transaction.
That means the executors are identified by the aggregator class that you use.
Because your entire transaction can have only one aggregator.
Therefore, the aggregator class is used in each and every time by representing the transaction.
For instance, according to the StackSaga example, the place order is the entire process.
It contains many sub processes like create order, check user ect.
Each process is introduced to the framework by using executors.
So, for each process have separate executors.
When you create each executor, you should mention what ks the aggregator that you want to use in that executor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can store/update the data in the aggregator by using the process execution only (doProcess()).
If you want to keep some metadata while your revert/compensation processes, you can use the hint-store that the framework provides.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="executor_architecture"><a class="anchor" href="#executor_architecture"></a>3.9. Executor</h3>
<div class="paragraph">
<p>According to the saga design pattern, you have to separate your entire transaction in to small atomic transactions.
In general, each atomic execution can have two executions called <strong>process execution</strong> and <strong>compensation execution</strong>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Process Execution / Main Execution</strong></p>
<div class="ulist">
<ul>
<li>
<p>The main execution that you want to archive the atomic transaction.<br>
<br>
As an example, In your <a href="#what_is_stacksaga">place order example</a> you had multiple individual processes to overcome the entire transaction like checking use&#8217;s validation, checking stock&#8217;s availability, updating stock, making payment, dispatching the order.
Those executions that caused to start the atomic processes are called as <strong>Process execution</strong>.<br>
Those are going forward [<span class="icon green"><i class="fa fa-arrow-circle-right fa-1x"></i></span>].</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Compensation Execution / Revert Execution</strong></p>
<div class="ulist">
<ul>
<li>
<p>Most of the <strong>Main Executions</strong> can have a revert process to undo the executions that were done before If you want to get state back of your changed data (Because you can&#8217;t do rollback just like you do in the Monolithic application).
The executions that are used for the reverting the done-process before are called as <strong>Compensation Executions</strong>.<br>
<br>
As an example, If the stock-updating process was done successfully but due to one of the next atomic executions' failures, the stock-updating execution should be restored (Undo the process or get the state back).<br>
If the main execution has a revert execution, Those are going backward [<span class="icon green"><i class="fa fa-arrow-circle-left fa-1x"></i></span>].</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though most of the executions can have a Compensation Execution / Revert Execution, Sometimes it is not.
It is based on your nature of the execution.
It can be explained by the CRUD operations.
If your atomic execution cased to a database&#8217;s state change, That kind of executions can have a revert execution to get the state back. <br>
As an example, In the above example, <strong>checking use&#8217;s validation, checking stock&#8217;s availability</strong> executions have no revert executions.
Because that were only read operations.<br>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Process Execution</th>
<th class="tableblock halign-left valign-top">Has a Revert</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>C</strong> - Create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>YES</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>R</strong> - Read</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>NO</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>U</strong> - Update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>YES</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>D</strong> - delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>YES</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To hand over your set of atomic transactions regarding the entire transaction to the <a href="#SEC">SEC</a>, you have to identify whether the atomic transaction has a revert operation or not.
Because StackSaga framework does provide tow Codespace types for setting up each atomic execution.</p>
</div>
<div class="paragraph">
<p>According to the framework, those <strong>Codespaces</strong> are called as <strong>Executors</strong>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#query_executor_architecture">Query executors</a></p>
<div class="ulist">
<ul>
<li>
<p>If some atomic process has no compensation (query execution), those kinds of processes are used in a query executor.<br>
— In <strong>Query Executor</strong> has only one <a href="#query_executor">method</a> for making the main process.</p>
<div class="paragraph">
<p><strong>Example</strong>: If you want to check, the user is active at the time of the transaction happen, and you want to keep the user&#8217;s activeness until the end of the transaction.<br>
<br>
<a href="#query_executor">Implementation</a>|<a href="#query_executor_architecture">Read More</a></p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#command_executor_architecture">Command executors</a></p>
<div class="ulist">
<ul>
<li>
<p>If some atomic process has a compensation (command execution), those kinds of processes are used in a command executor.<br>
— In <strong>Command executor</strong> has two <a href="#command_executor">methods</a> for making the main process and making the revert process.</p>
<div class="paragraph">
<p><strong>Example</strong>: Think that you want to create an order and order process is done successfully.
But after the make-payment process is failed.
Then the compensation process will be started.
Now you must have a compensation against the creating order.
So create an order process is a command process, and it goes to a command executor.<br>
<br>
<a href="#command_executor">Implementation</a> | <a href="#command_executor_architecture">Read More</a></p>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The below diagram shows the Executors types and what are the methods they have.
To see how you can implement these executors, <a href="#saga_executors">read here</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-e-store-example-executor-types-in-stacksaga.drawio.svg" alt="Stacksaga Executors" height="300">
</div>
</div>
<div class="sect3">
<h4 id="query_executor_architecture"><a class="anchor" href="#query_executor_architecture"></a>3.9.1. Query Executor</h4>
<div class="paragraph">
<p>In the query executor, you only have a one method to do your atomic execution.
It&#8217;s called as atomic process execution.
Upon the aggregator that you provided you will have the aggregator as a parameter.
That is the aggregator object which runs for the entire transaction.
In the method, you are permitted to read write and update the values from that object.
And you can invoke your atomic execution inside the method body by using the values of given aggregator.
According to the StackSaga example, just think we are going to check the user status.
To do this part, you already have the service class and the function.
For here, the only thing that you do is introduction that method and get the relevant data from the given aggregator.
The framework is responsible for invoking that method you mentioned. ** In one executor, you can introduce one atomic process only.</p>
</div>
<div class="paragraph">
<p>Finally, you have to return what is the next executor that you want to execute.
It is totally runtime.
You can decide it the data by using the given aggregator or by anything else.
Or, if your process is completed from this execution, you can notify about that by complete single.</p>
</div>
</div>
<div class="sect3">
<h4 id="command_executor_architecture"><a class="anchor" href="#command_executor_architecture"></a>3.9.2. Command Executor</h4>
<div class="paragraph">
<p>In the command executor, you will have two methods to be implemented.
One for the process the transaction forward.
And another one for its compensation.
Now you know what you can do inside the doProcess.
Let&#8217;s talk about the doRevert method.
This is the location that you can execute your compensation atomic transaction.
For here, you will have the final status of the aggregator.
What is the final status of the aggregator?
It means the aggregator will change on each and every executor&#8217;s doProcess method.
Some values are added and some values can be changed.
Just think the aggregator was used for 10 sub processes.
But the target processes are 20.
But the process can&#8217;t be executed further more due to the error that occurred at step number 10. That means old 9 steps (sub executions/ sub transactions) have been done successfully.
But 10 was failed.
The framework ignores the changes of the step number 10.
Because the atomic transaction is failed and updated data is not valid due to the failure.
Therefore, in the <code><strong>doRevert</strong></code> method, you will get the aggregator object that was before going to be executed at step number 10.
For instance, if you change the value of xyz variable as 2, but in the step number 9, the value of xyz is null.
Because you have set the value then.
Then step number 10 is failed.
So the final aggregator that you will be given is xyz = null.
In the revert method, you are not permitted to change the data.
Because it is the final status of the aggregator.
It should be immutable and all the revert methods should use the data to process the compensation.
Due to having the getters and setters, you can set the values and change the values by using the reference.
But the framework ignores those updates.
Another special thing is that the <strong><code>revert</code></strong> method doesn&#8217;t have a return.
Because the framework knows the order of the revert executions, and you can&#8217;t change the direction.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-command-executor-with-revert-executors.drawio.svg" alt=" Stacksaga Executors" height="300">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_executors_behave_in_the_application"><a class="anchor" href="#_how_executors_behave_in_the_application"></a>3.9.3. How Executors Behave In The Application.</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-e-store-example-what-is-executor-in-stacksaga.drawio.svg" alt=" Stacksaga Executors" height="300">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aggregator_and_executors"><a class="anchor" href="#aggregator_and_executors"></a>3.10. Relationship between Aggregator and Executors</h3>
<div class="paragraph">
<p>Here you can see all the sub sets of processes are connected with the aggregator.
Each sub process wants the aggregator to get run.
That means the data that executor wants to execute the sub process, is located at the aggregator.
If some executor is not linked with the aggregator, it is not configured in the framework.
You can see the executor-introduction or the real implementation of the example to learn more about the executors.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-e-store-example-aggregator-and-executors.drawio.svg" alt="StackSaga Aggregator And Executors" height="400">
</div>
</div>
<div class="sect3">
<h4 id="aggregator_usage_with_executor"><a class="anchor" href="#aggregator_usage_with_executor"></a>3.10.1. How the Aggregator is used through the Executors</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-e-store-example-aggregator-state.drawio.svg" alt="StackSaga Aggregator And Executors" height="300">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aggregator_versioning"><a class="anchor" href="#aggregator_versioning"></a>3.11. Aggregator Versioning</h3>
<div class="paragraph">
<p>In StackSaga, versioning is the most important thing for you as the developer.
All the applications are being updated with new versions ever.
In StackSaga, you have to manage your versioning for each aggregator.
Because any kind of changes that you make regarding the aggregator, it caused for a version update.
Not only the aggregators, even if you make some changes in one of the executors, It also causes a version update.
Because every change you make related to the aggregator, it will change the aggregator state.
If the aggregator-state is changed, the version must be updated.</p>
</div>
<div class="paragraph">
<p>As an example, if you have PlaceOrderAggregator, the following changes can be caused to a version update.</p>
</div>
<div class="paragraph">
<p><strong>Old Aggregator version Structure.</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/stacksaga-old-aggregator.drawio.svg" alt="Stacksaga Old Aggregator Version" width="500">
</div>
</div>
<div class="paragraph">
<p><strong>New Changes For Existing Aggregator Structure.</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Making changes in aggregator&#8217;s class.</strong></p>
<div class="imageblock">
<div class="content">
<img src="resources/img/stacksaga-aggregator-change.drawio.svg" alt="Stacksaga Making Aggregator Changes" width="500">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Compared to the old version, some changes have been made for the aggregator without doing any changes on the executors.
This will cause a version update.
<a href="#aggregator_oriented_casting_architecture">See more</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Adding new or removing existing executors</strong> (<a href="#query_executor_architecture">Query-Executor</a>, <a href="#command_executor">Command-Executor</a>, or <a href="#revert_after_executor">Revert-Executor</a>)</p>
<div class="imageblock">
<div class="content">
<img src="resources/img/stacksaga-executor-change.drawio.svg" alt="Stacksaga Updating Executors" width="500">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Compared to the old version, One Revert-Executor has been removed, and one Query-Executor and another Revert-Executor has been added as new executors.
This will cause a version update. <a href="#executor_oriented_casting_architecture">See more</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Making changes in the existing executors' classes.</strong></p>
<div class="imageblock">
<div class="content">
<img src="resources/img/stacksaga-executor-class-change.drawio.svg" alt="Stacksaga Making Executors Changes" width="500">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Compared to the old version, Some changes have been made for some existing executors without changing any executors.
This will cause a version update.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="version_casting_architecture"><a class="anchor" href="#version_casting_architecture"></a>3.12. Version Casting</h3>
<div class="paragraph">
<p>All the applications will be updated by changing their versions from time to time.
When a new version is deployed, the old version will be replaced by the new version (if you are not going to use service-mesh).
But in the event-based architecture, some events can have been waiting to be executed when the new version is being deployed or after deployed as well.
Then the old event should be mapped with the previous version.
And if you don&#8217;t consider the old version’s execution, when developing the new version, the events will be conflicted or crashed.
Because, the old version&#8217;s event is going to be executed by using the new version of the same service.
But the new version doesn&#8217;t allow the old events, and then the event will face for an exception due to that the event&#8217;s data is not mapped with different versions to be executed smoothly.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#aggregator_oriented_casting_architecture">Aggregator-Oriented casting</a></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Aggregator upcast</p>
</li>
<li>
<p>Aggregator downcast</p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#executor_oriented_casting_architecture">Executor-Oriented casting</a></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Executor upcast</p>
</li>
<li>
<p>Executor downcast</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="aggregator_oriented_casting_architecture"><a class="anchor" href="#aggregator_oriented_casting_architecture"></a>3.12.1. Aggregator-Oriented casting</h4>
<div class="paragraph">
<p>If some changes are done for the aggregator, it will cause for a version-update.
Even though the version is updated, there is something to be considered carefully.
After updating the aggregator&#8217;s version, it is not a problem for that particular version at all.
But StackSaga follows the event sourcing architecture and event re-invoking mechanism, in the event-store can have some events from the old version of the aggregator to be re-invoked.
Therefore, the SEC has to cast (map/convert/deserialize) the old aggregator event to the new version.
It is called as Aggregator-Oriented casting.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Even thought the term is quite simple at first glance, It can be effected to get crashed all the old events if you are unable to manage the version mapping.
The casting process is failed for the old version&#8217;s events, there is no chance to be re-invoked that retry process with the old versions.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though the casting process is done by the SEC, as the developer, you are responsible for managing the casting the new version with the old versions' events.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Based on the behavior of the aggregator state-change, the Aggregator-Oriented version casting can be divided to two.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong><a href="#aggregator_oriented_up_casting">Up-Casting</a></strong></p>
</li>
<li>
<p><strong><a href="#aggregator_oriented_down_casting">Down-Casting</a></strong></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="aggregator_oriented_up_casting"><a class="anchor" href="#aggregator_oriented_up_casting"></a>3.12.2. Aggregator-Oriented Up-Casting</h4>
<div class="paragraph">
<p>If the new aggregator has more new attributes than the old one, that kind of event should be cast with upcasting.</p>
</div>
<div class="paragraph">
<p>For instance, the old version&#8217;s aggregator has 3 fields, and the new version can have 4 fields or more than that, the old version&#8217;s events should be cast to the new aggregator object, and that term is called as upcasting.</p>
</div>
<div class="paragraph">
<p>The following image shows how it is done by the SEC.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-aggregator-oriented-up-casting-view.drawio.svg" alt="Stacksaga aggregator version up-casting">
</div>
</div>
<div class="paragraph">
<p><strong>Explanation:</strong> In the event-store can have old remaining events to be re-tried.
But due to the fact that the aggregator has been updated to a new version with new attributes, The old events also should be converted and should be run through the new aggregator.
But if it is an upcast mapping, The new version doesn&#8217;t bother to the casting process at all due that SEC uses <code>jackson objectmapper</code> to <strong>serialization</strong> and <strong>deserialization</strong> both.
The new values will have the default values with help of
<code>jackson objectmapper</code> and you have nothing to worry about upcasting with StackSaga at all. See the &lt;&lt;,technical documentation&gt;&gt;</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All the events that go through the SEO process can be identified easily in the <a href="#saga_executors">Executor&#8217;s</a> methods with the help of event-version data that provides with the aggregator object.
See the <a href="#technical documentation">[technical documentation]</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="aggregator_oriented_down_casting"><a class="anchor" href="#aggregator_oriented_down_casting"></a>3.12.3. Aggregator-Oriented Down-Casting</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-aggregator-oriented-down-casting-view.drawio.svg" alt="Stacksaga aggregator version down-casting">
</div>
</div>
<div class="paragraph">
<p>According to the example, the event-store might have the old events consisting of 2 fields.
And if the new version has a less number of fields than the old one, it is called as down-casting.
Now those remaining events are going to be executed through the new version.
And the framework tries to build the new aggregator object by using the old event&#8217;s binaries.
This is the time the casting is been worked on.
You have to modify and annotate the aggregator so as not to conflict while building the object by the framework.
Here you can see the best practices related to the casting of aggregators.</p>
</div>
</div>
<div class="sect3">
<h4 id="executor_oriented_casting_architecture"><a class="anchor" href="#executor_oriented_casting_architecture"></a>3.12.4. Executor-Oriented Casting</h4>
<div class="paragraph">
<p>According to the framework, one aggregator can have multiple executors based on your use case.
When you update the version of the service, you might want to remove existing executors or add new executors based on the update that should be done.
If you are going to add more additional executors to the existing aggregator that is called as <strong>executor-oriented upcasting</strong>.
And the opposite of that, if you remove some existing executors from the aggregator, that form is called as <strong>executor-oriented-down-casting</strong>.
Adding more is not a problem when the old event executors at all.
Just think, for instance, the old aggregator had 3 executors and the new aggregator has 4 executors due to the additional one, which has been added.
And after deploying the new version, the old events are executed through the new version.
That execution is not conflicted because, all the necessary executors are in the new version.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
IF there is an executor down-cast scenario, This time is not just like Executor-oriented-down-casting because the old event should have all the expected executors to be executed as you plan that event should be executed upon the old version&#8217;s use case.
But in the new version, if one or more executors do not exist, most of the time the execution can be crashed.
(In rare cases, it might not be affected upon your update) by the way, even though you want to use some executors for the previous version and for the new version that executor is not used, that kind of situation is called as executor-oriented down-casting changes.
To avoid conflict in this way, the framework provides a feature to skip the old executor from the latest version, and the old executor is retained only for the remaining old events as it&#8217;s.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_up_casting"><a class="anchor" href="#_up_casting"></a>3.12.5. up-casting</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-executor-oriented-version-up-casting.drawio.svg" alt="Architecture Stacksaga executor-oriented version up-casting" height="400">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dual_consistency_problem_of_sec_in_microservice"><a class="anchor" href="#dual_consistency_problem_of_sec_in_microservice"></a>3.13. Dual-Consistency problem of SEC in microservice.</h3>
<div class="paragraph">
<p>In the microservice architecture, It is highly concerned about the data consistency.
As a result of that, you had to move in to the <a href="#introduction_to_saga">SAGA design pattern,</a> and it ensures eventual consistency.</p>
</div>
<div class="paragraph">
<p>But you know that <a href="#SEC">SEC</a> also uses a database internally for storing the event data for retry purpose in StackSaga.
SEC is also another program that supports for your execution as a middleware framework.
That means that all the executions are saved in the database as an event by the StackSaga framework before the real execution.
Because, in case your atomic transaction is failed for some reason, the atomic transaction should be retried by the SEC.
To do re-play, the old state should be in the hand of the StackSaga.</p>
</div>
<div class="paragraph">
<p>Just imagine that Your entire domain (<a href="#quick_understanding_example">place order example</a>) can have 5 atomic transactions inside the <a href="#executor_architecture">executors</a>.
After calling the execution through the <a href="#saga_template"><code>SagaTemplate</code></a>, StackSaga starts execution one by one as you configured order by the developer.
Then, before executing the transaction, the transaction should be initialized in the event-store.
In that case, StackSaga uses the event-store to store the event data at the 1st time in the transaction execution.
After successfully saving the initial event data, you will have a transaction id (<a href="#creating_aggregator_class">aggregatorTransactionId</a>).
And after that, your 1st executor will be executed by the SEC.
After executing your 1st atomic transaction, again the updated state is saved in the event-store by SEC.
Like so, all the time your state is saved in the event-store.
Then just think that after executing the 2nd atomic transaction (execution) SEC going to update the event-store and then an error is occurred due to connection issues of the event-store database.</p>
</div>
<div class="paragraph">
<p>Then the framework is failed to provide the data consistency by themselves of their side.
But the real fact, the first reason is for choosing a framework is to overcome the data consistency.
But If the framework is not capable of handling the data consistency by itself, there is no point in using a framework.</p>
</div>
<div class="paragraph">
<p><mark>In brief, The responsibility of protecting both data-consistency of internal event-store and your transaction&#8217;s data-consistency is known as the Dual consistency problem of SEC.
</mark></p>
</div>
<div class="paragraph">
<p>Even though it is not possible technically to handle by the database side, StackSaga provides a best solution for that.
It is called as *Execution Chunk Protection Mechanism * in StackSaga.</p>
</div>
<div class="sect3">
<h4 id="how_execution_chunk_protection_works"><a class="anchor" href="#how_execution_chunk_protection_works"></a>3.13.1. How <strong>Execution Chunk Protection Mechanism</strong> works</h4>
<div class="paragraph">
<p>In brief, In the Execution Chunk Protection Mechanism, chunk execution data will be stored in the shared filesystem for the particular instance.</p>
</div>
<div class="paragraph">
<p>If the database connection (event-store) is failed for some reason during the execution of your executor.
The framework doesn&#8217;t give up the process due to the event-store problem.
The event-store will be back to normal soon for sure.
But while then, the transaction data must be kept in somewhere because your executor has already been executed.
Those events are called as <strong>Execution Chunk</strong>.
That chunk-data is stored in the file system temporally while the event-store is back to normal.
Ones the event-store connection is back to normal, all the chunk-data files are restored in the event-store by the framework.
After restoring the chunk-data files, the transaction is exposed to be run for the next scheduler and the transaction will be continued as usual.
To make the chunk-data file, the entire data set is converted into the JSON format by using the <a href="#aggregator_mapper_implementation">mapper</a> that you provided for the target aggregator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To ensure the permissions of the shared file system to write the files, StackSaga checks the permissions before the application is started.
If there is a permission issue, the application is terminated immediately (Only the application is stated).
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Execution Chunk Protection Mechanism* protects the partially executed transactions only.
Just imagine the instance is executing a hundred of transactions at the time of the event-store connection is failed, all the transaction execution data is saved in the file storage temporally.
But during the event-store connection is failed,
<a href="#saga_template">SagaTemplate</a> the SEC does not accept all the new transactions that received through the SgaTemplate in to the SEC.
IF the transaction initialization process is failed, it will throw an <code>TransactionInitializationFailedException</code> immaterially.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At first glance, it is a simple solution the <strong>Execution Chunk Protection Mechanism</strong> will be very complicated when is it considered from the microservice architecture.</p>
</div>
<div class="paragraph">
<p>In the microservice architecture, it is used as a stateless service when it is considered saving files in the storage.
Because caching file is not recommended in microservice architecture inside the individual instance.
The reason for that is at any time, any instance can be created or deleted based on the auto-scaling.
In case, an instance went down with chunk-data; there is no way to recover that data at all.
Therefore, it is used a shared common file storage for each of them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are familiar with <a href="https://docs.docker.com/storage/volumes/">Docker</a> or <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Kubernetes</a>, the file storage that is used is called as <strong>persistent volumes</strong>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="execution_chunk_protection_mechanism_with_the_help_of_eureka_service_registry"><a class="anchor" href="#execution_chunk_protection_mechanism_with_the_help_of_eureka_service_registry"></a>3.13.2. Execution chunk protection mechanism with the help of eureka service registry.</h4>
<div class="paragraph">
<p>According to the StackSaga architecture, eureka service helps to <strong><code>Execution chunk protection</code></strong> process by providing the instance metadata for each instance.</p>
</div>
<div class="paragraph">
<p>As mentioned above, one unique folder is created for each instance by the StackSaga when the application is started.
To create the folder for each instance uniquely, the instance information that eureka provides is used as the 1st.</p>
</div>
<div class="paragraph">
<p>When the directory is created for saving the files, the following properties are considered.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Region</strong>: The region of the instance is located currently.</p>
</li>
<li>
<p><strong>Availability Zone</strong>: The availability zone of the instance is located currently.</p>
</li>
<li>
<p><strong>Service-Name</strong>: The service name of the instance (<code>spring.application.name</code> is used).</p>
</li>
<li>
<p><strong>Instance-ID</strong>: The unique id of the instance. (<a href="https://cloud.spring.io/spring-cloud-netflix/multi/multi__service_discovery_eureka_clients.html#_changing_the_eureka_instance_id"><code>eureka.instance.instanceId</code></a> is used )</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though instance-id and service Name are provided by default by Eureka and Spring Web, You have to provide other extra instance-related <a href="#stacksaga_discovery_configuration_properties">properties</a> through the Eureka metadata.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can provide the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html"><strong>Region</strong> and <strong>Availability Zone</strong></a> of the instance through the application properties.
Or otherwise, the default value (defaultRegion and defaultZone) will be used.
If your entire application is running on only a single region, you can keep the default value as it is.
But if your application is running on cluster environment, you can obtain what is the current region the instance is running on and configure it through` the property.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Based on the above properties here you can see that how a <code>order-serivice</code> instance&#8217;s directory is created in the filesystem.</p>
</div>
<div class="paragraph">
<p><strong>Directory Path</strong> <code>baseDir/<mark>US_East</mark>/<mark>us-east-2</mark>/<mark>order-serice</mark>/<mark>3365ec45-51e7-470b-ba10-1ebf6a318bb6</mark></code></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This diagram shows how the file system looks like in general with default region and default zone.</p>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-e-store-example-chunk-files-in-default-region-and-zone.drawio.svg" alt="StackSaga Chunk Files In default Region Adn Zone" height="300">
</div>
</div>
<div class="paragraph">
<p>In this diagram, you can see two default servers called order-service and user-service with default region and default zone.
That means each service has a folder, and inside the folder the instance&#8217;s folder is created.
Here two servers have been run, and those services have had two instances.
As well as, the instances might have chunk-files waiting to be restored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In your entire application can have multiple servers that StackSaga framework is used.
Just imagine your entire application system has 100 services (like user-service, order-service, delivery-service etc.).
Among them, there are 20 services use StackSaga on their services.
Then you will have 20 folders in the root folder by that service names.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you have multiple regions and multiple availability zones with multiple instances, the file storage will be like this.</p>
<div class="imageblock">
<div class="content">
<img src="resources/img/stack-saga-e-store-example-chunk-files-in-mulltiple-regions-adn-zones.drawio.svg" alt="StackSaga Chunk Files In Mulltiple Regions Adn Zones" height="300">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If it is a cluster architecture, it is recommended to use zone-specific file storage for each to avoid the latency and file protection.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here we are going to discuss the worst case.
Saving files inside the file system is not a considerable thing.
But restoring the files in without a data-loss is very important.
Then let&#8217;s see' that how can be a data-loss here.
As it is mentioned above, you know that in the microservice architecture any instance can be removed at any time.
Just imagine some of the instances are removed due to a scale down.
Even though those instances have been deleted, the chunk-files can be in the file storage.
If the instance is responsible for restoring the files that the instance has added to the file storage, those directories have not responsible instance up and running at this moment due to the scale down.</p>
</div>
<div class="paragraph">
<p>To avoid this issue, StackSaga does use a <strong>master and slave architecture</strong> when the chunk-files are restored.</p>
</div>
<div class="paragraph">
<p><strong>What is master and slave architecture for chunk-files restoring?</strong></p>
</div>
<div class="paragraph">
<p>This architecture is limited to the zone.
That means that it can have a master node for each zone and other services are considered as slaves inside the zone.</p>
</div>
<div class="paragraph">
<p><strong>Chunk Relocating Process By The Master node</strong></p>
</div>
<div class="paragraph">
<p>Let&#8217;s dive into the deep how this problem is solved by the master and slave architecture.
After appointing as the master service for the zone, the master server does not act like other services.
Because, For the service that becomes as the master has different responsibilities that the slaves.
In general, every instance tries to restore the chunk-files that inside the particular instance&#8217;s folder.
To identify the instance their folder&#8217;s name, it uses the instance-Id from the eureka instance-info.
But if the instance is the Master server, it checks what folders are available in the service&#8217;s folder without having up and running instances.</p>
</div>
<div class="paragraph">
<p>If there are some folders like that, all the files that are inside those folders are moved to other available instances' folders at that moment.
Then that instance will restore the files to the event-store.</p>
</div>
<div class="paragraph">
<p>And specially, The master node also has a folder, and also it can have the chunk files when the schedule is triggered.
But due to the instance being the master node, it has another responsibility for <strong>relocating</strong> the files into available instances.
Therefore, the master node doesn&#8217;t try to restore the files of the folder its own as well.</p>
</div>
<div class="paragraph">
<p>The master&#8217;s folder is also considered as a folder that has no responsible instance, and those files are moved to another instance&#8217;s folder too.</p>
</div>
<div class="paragraph">
<p>That means, the master node changes the ownership of the files if those files have no a responsible-instance up and running.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The master node is appointed by considering the time that service started.
All the service has the available service registry through the eureka server.
By using the cache, all the services check whether I am a master or slave.
If the instance has the most past timestamp, that instance appoints as the master by itself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here you can see how Chunk Relocating Process is done by StackSaga with help the of Eureka.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/stacksaga-unit-test-Trash-File-Collecting-MI-MZ.drawio.svg" alt="StackSaga Chunk Files In Mulltiple Regions Adn Zones" height="300">
</div>
</div>
<div class="paragraph">
<p>For your understanding, the image shows two zones.
But having multiple zones is not effected to the Relocating process.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the zone-A.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The zone-A has 4 instances up and running at this moment.</p>
</li>
<li>
<p>The master node is instance-1.
And you can see in the file system there is a directory without an up and running instance.
(The folder belonged to the instance-5, but the instance-5 went down rectally) That means, that folder&#8217;s instance went down recently without restoring the chunk-files.</p>
</li>
<li>
<p>Therefore, the master instance moves that directory&#8217;s files to another folder that the responsible instance is up and running.</p>
</li>
<li>
<p>As we mentioned above, you can see the master instance&#8217;s files (instance-1) also moved to another folder by the master due to the master has its own responsibility.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
After relocating the files, the empty folders are deleted by the master node as well.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can customize the scheduler as you want.
But there is no any scheduler for Relocating process.
You can only configure the scheduler for checking the chunk-files in the filesystem.
But if some instance is appointed as the master that same scheduler will be used for the relocating process.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="stacksaga_discovery_configuration_properties"><a class="anchor" href="#stacksaga_discovery_configuration_properties"></a>3.13.3. StackSaga Discovery Configuration Properties</h4>

</div>
</div>
<div class="sect2">
<h3 id="replay_transaction"><a class="anchor" href="#replay_transaction"></a>3.14. Transaction Replay.</h3>
<div class="paragraph">
<p>Transaction Replay concept is help to re-invoke the transaction that stopped for some reason in the past.
Even though all the transactions can not be re-invoked, some transactions/executions can be re-invoked.
Specially in the microservice architecture, a transaction can be deviated in to small atomic operations.
Therefore, that atomic process can be failed at any time for some reason.
But we have to be careful with that error if we are in a <strong>distributed transaction</strong>.
It is not like in a standalone application with a single database.
After executing some atomic operations successfully, reverting that executed executions is quite complicated than doing rollback in a single database.
Even though Saga provides the way to have the compensation, we can not give up the entire transaction easily.
Therefore, it should be identified whether the transaction can be re-invoked or not.</p>
</div>
<div class="paragraph">
<p>The following reasons are caused to Transaction Replay.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>IF the transaction executor was failed with <a href="#non_retryable_executor_exception">NonRetryableExecutorException</a>.<br>
Any <a href="#executor_architecture">executor</a> can be re-invoked in StackSaga.
After executing your logic inside the executor, you can provide to the <a href="#SEC">SEC</a> what should be done as the next based on your conditions.
IF the executed transaction is failed due to a retry-able exception that executor can be re-invoked.
That helps to have the eventual consistency of the entire transaction.</p>
</li>
<li>
<p>IF a <a href="#dual_consistency_problem_of_sec_in_microservice">chunk-data</a> file is restored after every-store problem.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>IF your application is a large one.
There can be a lot of retryable transactions from each service in the event-store.
Therefore, executing the retryable transactions will be a heavy process due to the bulk.
To overcome this problem, StackSaga shares all the retryable transactions within the available instances in the zone.
The architecture is quite the same as <a href="#execution_chunk_protection_mechanism_with_the_help_of_eureka_service_registry">chunk-data file relocating</a>.
To share the transactions within the available instances, StackSaga follows the master and slave architecture.</p>
</div>
<div class="paragraph">
<p><strong>How is the master node appointed with the help of Eureka Registry?</strong></p>
</div>
<div class="paragraph">
<p>For selecting the master node, StackSaga uses eureka client metadata.
When the instance is started, StackSaga adds the timestamp as a metadata to the Eureka instance Info.
Then all the instances know who is the oldest instance in the zone.
The older instance will be appointed as the master node by itself.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/stacksaga-unit-test-Transaction-Replay-Architecture-MI.drawio.svg" alt="StackSaga Transaction Replay Architecture" height="300">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="rounded-number">1</span> Master gets the service registry from the eureka cache, and allocates retryable-transactions in the event-store for each available instance.
In the diagram, instance-1 makes the retryable-transactions allocation (you can configure the allocation count) for instance-2, instance-3, and instance-4.</p>
</li>
<li>
<p><span class="rounded-number">2</span> After making the allocation for each.
the master notifies to each instance by making http requests.</p>
</li>
<li>
<p><span class="rounded-number">3</span>  Then each instance starts the executing the allocated retryable-transactions bulk.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Each availability zone has a master node.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After becoming as the master node, the instance has a special responsibility other than the slaves.
Here there is an allocation process by the master for other instances in the zone.</p>
</div>
<div class="paragraph">
<p>The slaves try to invoke the <strong>allocated</strong> retryable transactions for that particular instance by the master node.</p>
</div>
</div>
<div class="sect2">
<h3 id="stack_saga_transaction_type"><a class="anchor" href="#stack_saga_transaction_type"></a>3.15. StackSaga Transaction Types</h3>
<div class="paragraph">
<p>In this section, you will get the architecture of this framework.
Other than that, you will get what are the limitations you have to face when you are going to use microservice architecture and how to overcome those difficulties by using StackSAGA framework.</p>
</div>
<div class="paragraph">
<p>You know that in the saga flow, the transaction can be divided into 3 types according to the behavior of the transaction.
Let&#8217;s see one by one how the StackSaga&#8217;s execution-coordinator coordinates (SEC) each component with each transaction type.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong><a href="#fully_success_transaction_scenario">Fully success transaction scenario</a></strong></p>
</li>
<li>
<p><strong><a href="#revert_success_transaction_scenario">Revert success transaction scenario</a></strong></p>
</li>
<li>
<p><strong><a href="#revert_failed_transaction_scenario">Rollback/Compensation/Revert failed transaction scenario</a></strong></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="fully_success_transaction_scenario"><a class="anchor" href="#fully_success_transaction_scenario"></a>3.15.1. <span class="icon green"><i class="fa fa-circle"></i></span> Fully Success</h4>
<div class="paragraph">
<p>here, the SEC has successfully executed all the executors. therefore, there is no compensation/revert execution was invoked. this is the success scenario we wish.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-fully-success-transaction-stacksaga.drawio.svg" alt="StackSaga High-level architecture" height="300">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="rounded-number">1</span> As the first step the user makes the request and the <strong>OrderController</strong> catch the request.</p>
</li>
<li>
<p><span class="rounded-number">2</span> After having the request, initialize the place order aggregator and set the start executor into the StackSaga.
(In this time you have the transaction uid which is created by framework.
The transaction uid is the unique id for identifying each transaction.
You can get it from your created Aggregator object.)</p>
</li>
<li>
<p><span class="rounded-number">3</span> now the execution processes are handled by the SEC.
Before invoking the executor that you provided as the start-executor SEC saves the initial state of the aggregator in the event-tore.</p>
</li>
<li>
<p><span class="rounded-number">4</span> SEC executes the start-executor<strong> ([Command] CreateOrderExecutor)</strong> that you provided. <span class="rounded-number">4.1</span> due to the executing the process method by the SEC, the <strong>InternalOrderService&#8217;s</strong> <strong>createOrder()</strong> method will be invoked. <span class="rounded-number">4.2</span> after successfully invoking the method, SEC will store the state of the aggregator. <span class="rounded-number">4.3</span> after saving the state in the event-store, SEC will execute the <strong>onEachProcessPerformed</strong> method of the handler class that you provided. <span class="rounded-number">4.4</span> then you can put your execution here to update the status of the place-order transaction. as the diagram, we have executed <strong>updateCustomerOrderStatus()</strong> method of <strong>InternalOrderService</strong> to update the status. <span class="rounded-number">4.5</span> after updating the status of the place-order, you can notify your customer by sending the email or SMS or whatever method about the status of the order.</p>
</li>
<li>
<p><span class="rounded-number">5</span> SEC executes the 2nd executor that you provided from the 1st executor. <span class="rounded-number">5.1</span> due to the executing the <strong>doProcess</strong> method of the <strong>[Query] UserExecutor</strong> by the SEC, the <strong>ExternalUserStatusService&#8217;s</strong> <strong>checkUser()</strong> method will be invoked.
<span class="rounded-number">5.2</span> the <strong>ExternalUserStatusService</strong> will call the <strong>user-service</strong> and make a request.
<Span class="rounded-number">5.3</span> after successfully invoking the request, SEC will store the state of the aggregator of 2nd process. <Span class="rounded-number">5.4</span> after saving the state in the event-store, SEC will execute the <strong>onEachProcessPerformed</strong> method of the handler class that you provided.</p>
<div class="paragraph">
<p><mark>Due to this executor is a query executor, there is no status update process has been executed here.</mark></p>
</div>
</li>
<li>
<p><span class="rounded-number">6</span> SEC executes the <strong>[Command] PaymentExecutor</strong> executor that you provided. <span class="rounded-number">6.1</span> due to the executing the process method by the SEC, the <strong>ExternalPaymentService&#8217;s</strong> <strong>makePayment()</strong> method will be invoked. <span class="rounded-number">6.2</span> the <strong>ExternalPaymentService</strong> will call the <strong>payment-service</strong> and make a request to make-payment process. <span class="rounded-number">6.3</span> after successfully making the request, SEC will store the state of the aggregator. <span class="rounded-number">6.4</span> after saving the state in the event-store, SEC will execute the <strong>onEachProcessPerformed</strong> method of the handler class that you provided. <span class="rounded-number">6.5</span> then you can put your execution here to update the status of the place-order transaction. as the diagram, we have executed <strong>updateCustomerOrderStatus()</strong> method of <strong>InternalOrderService</strong> to update the status. <span class="rounded-number">6.6</span> after updating the status of the place-order, you can notify your customer by sending the email or SMS or whatever method about the status of the order.</p>
</li>
<li>
<p><span class="rounded-number">7</span> SEC executes the <strong>[Command] DeliveryExecutor</strong> that you provided. <span class="rounded-number">7.1</span> due to the executing the process method by the SEC, the <strong>ExternalDeliveryService&#8217;s</strong> <strong>addToDelivery()</strong> method will be invoked. <span class="rounded-number">7.2</span> the <strong>ExternalDeliveryService</strong> will call the <strong>delivery-service</strong> and make a request to add-to-delivery process. <span class="rounded-number">7.3</span> after successfully making the request, SEC will store the state of the aggregator. <span class="rounded-number">7.4</span> after saving the state in the event-store, SEC will execute the <strong>onEachProcessPerformed</strong> method of the handler class that you provided. <span class="rounded-number">7.5</span> then you can put your execution here to update the status of the place-order transaction. as the diagram, we have executed <strong>updateCustomerOrderStatus()</strong> method of <strong>InternalOrderService</strong> to update the status. <span class="rounded-number">7.6</span> after updating the status of the place-order, you can notify your customer by sending the email or SMS or whatever method about the status of the order.</p>
</li>
<li>
<p><span class="rounded-number">8</span> as the final step the SEC will invoke the <strong>onTransactionCompleted</strong> method of the handler. <span class="rounded-number">8.1</span> you can update the place-order status as the final state as <strong>success</strong>. <span class="rounded-number">8.2</span> after updating the place-order status, you can notify it to the customer.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="revert_success_transaction_scenario"><a class="anchor" href="#revert_success_transaction_scenario"></a>3.15.2. <span class="icon yellow"><i class="fa fa-circle"></i></span> Compensation Success</h4>
<div class="paragraph">
<p>here, the SEC hasn&#8217;t successfully executed all the executors. an error occurred while after some processing. therefore, the transaction has a compensation/revert executions.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-revert-success-transaction-scenario.drawio.svg" alt="Compensation/Revert success transaction scenario" height="300">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="rounded-number">1</span> as the first step the users make the request and the <strong>OrderController</strong> catch the request.</p>
</li>
<li>
<p><span class="rounded-number">2</span> after having the request, initialize the place order aggregator and set the start executor into the StackSaga.
(In this time you have the transaction uid which is created by framework.
The <strong>transaction uid</strong> is the unique id for identifying each transaction.
You can get it from your created <strong>Aggregator</strong> object.
)</p>
</li>
<li>
<p><span class="rounded-number">3</span> now the execution processes are handled by the SEC.
Before invoking the executor that you provided as the <strong>start-executor</strong> SEC saves the initial state of the aggregator in the <strong>event-tore</strong>.</p>
</li>
<li>
<p><span class="rounded-number">4</span> SEC executes the start-executor<strong> ([Command] CreateOrderExecutor)</strong> that you provided. <span class="rounded-number">4.1</span> due to the executing the process method by the SEC, the <strong>InternalOrderService&#8217;s</strong> <strong>createOrder()</strong> method will be invoked. <span class="rounded-number">4.2</span> after successfully invoking the method, SEC will store the state of the aggregator. <span class="rounded-number">4.3</span> after saving the state in the event-store, SEC will execute the <strong>onEachProcessPerformed</strong> method of the handler class that you provided. <span class="rounded-number">4.4</span> then you can put your execution here to update the status of the place-order transaction. as the diagram, we have executed <strong>updateCustomerOrderStatus()</strong> method of <strong>InternalOrderService</strong> to update the status. <span class="rounded-number">4.5</span> after updating the status of the place-order, you can notify your customer by sending the email or SMS or whatever method about the status of the order.</p>
</li>
<li>
<p><span class="rounded-number">5</span> SEC executes the 2nd executor that you provided from the 1st executor. <span class="rounded-number">5.1</span> due to the executing the <strong>doProcess</strong> method of the <strong>[Query] UserExecutor</strong> by the SEC, the <strong>ExternalUserStatusService&#8217;s</strong> <strong>checkUser()</strong> method will be invoked. <span class="rounded-number">5.2</span> the <strong>ExternalUserStatusService</strong> will call the <strong>user-service</strong> and make a request. <span class="rounded-number">5.3</span> after successfully invoking the request, SEC will store the state of the aggregator of 2nd process. <span class="rounded-number">5.4</span> after saving the state in the event-store, SEC will execute the <strong>onEachProcessPerformed</strong> method of the handler class that you provided.</p>
<div class="paragraph">
<p><mark>Due to this executor is a query executor, there is no status update process have been executed here.</mark></p>
</div>
</li>
<li>
<p><span class="rounded-number">6</span> SEC executes the <strong>[Command] PaymentExecutor</strong> executor that you provided. <span class="rounded-number">6.1</span> due to the executing the process method by the SEC, the <strong>ExternalPaymentService&#8217;s</strong> <strong>makePayment()</strong> method will be invoked. <span class="rounded-number">6.2</span> the <strong>ExternalPaymentService</strong> will call the <strong>payment-service</strong> and make a request to make-payment process. at this time, the request failed due to an exception.</p>
</li>
<li>
<p><span class="rounded-number">7</span> the SEC will invoke <strong>onProcessException</strong> method of the handler class that you provided. there you can get notified about the <strong>process failure.</strong> the transaction can&#8217;t be executed forward anymore, the compensation process will start from this point.</p>
<div class="paragraph">
<p>**if you want to update the order status or update the customer, you can invoke your code here. in this example, it hasn&#8217;t been implemented.</p>
</div>
</li>
<li>
<p><span class="rounded-number">8</span> due to the final successful executed <strong>OrderExecutor</strong> (There is no compensation because the UserExecutor is a query executor.) SEC invokes the <strong>doRevert</strong> method of the <strong>OrderExecutor</strong>. <span class="rounded-number">8.1</span> due to the executing of the <strong>doRevert</strong> method, <strong>createOrderRevert</strong> method will be invoked and do the revert process of the make-payment. <span class="rounded-number">8.2</span> in the compensation process if you want to store some data regarding the revert process, you can store them into the [hint-store] the framework provides. that stored data is saved at this step. <span class="rounded-number">8.4</span> after invoking successfully the revert, the SEC will invoke <strong>onEachRevertPerformed</strong> method regarding the revert process. <span class="rounded-number">8.4</span> the customer will be notified about the revert process. (if you want to update the order status, you can invoke your code here as well. that part hasn&#8217;t been implemented in this example.)</p>
</li>
<li>
<p><span class="rounded-number">9</span> StackSaga state-machine knows that the compensation is done. therefore, SEC invokes the <strong>onTransactionCompleted</strong> method as <strong>REVERT_SUCCESS</strong>. <span class="rounded-number">9.1</span> you can update the status of the place-order regarding the revert was processed. <span class="rounded-number">9.2</span> after that the customer will be notified about the revert success process of their order.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To keep the overall state of the transaction eventually consistent, the revert processes (compensation processes) can be retryable.
Because all the compensations must be invoked.
To have knowledge about how retry works of revert-processes in StackSaga, please refer to <a href="https://mafei-dev.github.io/stacksaga-doc/architecture/1.0/topics/retryable-exception-vs-non-retryable-exception.html#how-retry-works-in-the-revert-process">this</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="revert_failed_transaction_scenario"><a class="anchor" href="#revert_failed_transaction_scenario"></a>3.15.3. <span class="icon red"><i class="fa fa-circle"></i></span> Compensation Failed</h4>
<div class="imageblock">
<div class="content">
<img src="resources/img/Architecture-Stacksaga-evert-failed-transaction-scenario.drawio.svg" alt="Compensation/Revert failed transaction scenario" height="300">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stacksaga_admin_index"><a class="anchor" href="#stacksaga_admin_index"></a>4. StackSaga Admin</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="icon"><i class="fa fa-tachometer fa-4x"></i></span></p>
</div>
<div class="paragraph">
<p>StackSaga Admin Server is the monitoring dashboard of the StackSaga framework.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Event though StackSaga framework can be run without the admin-server, it is recommended to connect the admin-server with other StackSaga clients.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. ROLES</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ROLE</th>
<th class="tableblock halign-left valign-top">Permissions</th>
<th class="tableblock halign-left valign-top">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUPER_ADMIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- Manage Admin Users</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER_TYPE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADMIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- Manage OPERATOR_ROLE<br>
- Manage GATEWAY_ROLE<br>
- Manage SERVICE_ROLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER_TYPE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPERATOR_ROLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- Monitor the transactions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USER_TYPE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GATEWAY_ROLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- Connect Gateway</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">APPLICATION_TYPE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERVICE_ROLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- Connect Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">APPLICATION_TYPE</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, super admin has an operator role as well.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Admin Service Specification</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Context</th>
<th class="tableblock halign-left valign-top">Technology</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backend</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring boot with reactive</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frontend</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Angular</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mysql with the help of spring R2DBC and liquibase</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWT for <strong>Front Users</strong>, and  Basic authentication for <strong>Gateway Users</strong> and <strong>Service Users</strong>.</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="setup_the_service"><a class="anchor" href="#setup_the_service"></a>4.1. Set up The Service</h3>
<div class="paragraph">
<p>StackSaga Admin Server can be started in multiple ways.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#stacksaga_admin_docker_image">Using Docker Image</a></p>
</li>
<li>
<p><a href="#stacksaga_admin_jar">Using Jar</a></p>
</li>
<li>
<p><a href="#stacksaga_admin_source">Using Source</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="stacksaga_admin_docker_image"><a class="anchor" href="#stacksaga_admin_docker_image"></a>4.1.1. StackSaga Admin Docker Image</h4>
<div class="paragraph">
<p>If docker is running on your computer, you can build a container and run StackSaga server (admin) by using the docker StackSaga server (admin) docker image.<br></p>
</div>
<div class="paragraph">
<p>You can choose the StackSaga server wit specific database that you want. <a href="https://hub.docker.com/u/stacksaga">See all images on docker hub.</a></p>
</div>
<div class="paragraph">
<p>For instance, if you prefer to use mysql StackSaga server, you can run the code to pull the image.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="shell">docker pull stacksaga/stacksaga_admin_mysqll:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>After pulling the image, you can create an image, and then you have to provide the following Environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="shell">docker run <span class="nt">-d</span> <span class="se">\</span>
<span class="nt">-p</span> 4444:4444 <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DB_URL</span><span class="o">=</span>jdbc:mysql://localhost:3306/stacksaga_admin_db?createDatabaseIfNotExist<span class="o">=</span><span class="nb">true</span>  <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DB_R2DBC_URL</span><span class="o">=</span>r2dbc:mysql://localhost:3306/stacksaga_admin_db <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DB_USERNAME</span><span class="o">=</span>root <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="k">***</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DROP_FIRST_DB</span><span class="o">=</span>your-config <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">SECRET</span><span class="o">=</span><span class="k">***</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">TOKEN_EXPIRATION_TIME</span><span class="o">=</span>60000 <span class="se">\</span>
<span class="nt">--name</span> stacksaga-admin-server <span class="se">\</span>
stacksaga/stacksaga_admin_mysql:1.0.0</code></pre>
</div>
</div>
<div id="docker_compose_file" class="paragraph">
<p>OR, if you prefer doing the deal with docker compose, here is the basic code snippet that you want to run your own container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">stacksaga_admin_mysql</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">stacksaga_admin_mysql</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">stacksaga/stacksaga_admin_mysql:1.0.0"</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">4444:4444"</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">DB_URL=jdbc:mysql://host.docker.internal:3306/stacksaga_admin_db?createDatabaseIfNotExist=true</span>
      <span class="pi">-</span> <span class="s">DB_R2DBC_URL=r2dbc:mysql://host.docker.internal:3306/stacksaga_admin_db</span>
      <span class="pi">-</span> <span class="s">DB_USERNAME=root</span>
      <span class="pi">-</span> <span class="s">DB_PASSWORD=mafei</span>
      <span class="pi">-</span> <span class="s">DROP_FIRST_DB=true</span>
      <span class="pi">-</span> <span class="s">SECRET=c403ba24-ea8f-4285-977a-a5b6361b427a</span>
      <span class="pi">-</span> <span class="s">TOKEN_EXPIRATION_TIME=600000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to run the docker-compose file, go the file directory and run this code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="shell">docker compose up</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stacksaga_admin_jar"><a class="anchor" href="#stacksaga_admin_jar"></a>4.1.2. StackSaga Admin Jar</h4>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-download fa-2x"></i></span>
Here is the standalone version of StackSaga admin server.
You can download the <strong>stack-saga-admin-server.zip</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Downloads</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://mega.nz/folder/w8lRXYyI#q5CFtVrNTCJtqYUuDzPPkA">StackSaga Admin Server - MySQL</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Minimum Requirements</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java java 8 or upper</p>
</li>
<li>
<p>Selected Database</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After unzipping the file, you will see the jar file.
To run the jar file, run the <code>START.sh</code> file or the following code below.
Before run the jar, make sure to config your custom configuration in the <code>application-proud.properties</code> file.</p>
</div>
<div class="paragraph">
<p><strong>&gt; Run on the console</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="shell">java <span class="nt">-jar</span> stack-saga-admin-1.0-SNAPSHOT.jar <span class="nt">--spring</span>.config.location<span class="o">=</span>file:application-proud.properties</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As you know in Spring application the default configuration file is <code>application.properties</code>.
But your custom configurations should be in the <code>application-proud.properties</code> file.
Because all the necessary configurations have been set in the default configuration file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All the required configurations are as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="properties"><span class="c">#security
</span><span class="py">stacksaga.admin.security.expiration-time</span><span class="p">=</span><span class="s">60000</span>
<span class="py">stacksaga.admin.security.secret</span><span class="p">=</span><span class="s">********************************</span>
<span class="c">#r2dbc
</span><span class="py">spring.r2dbc.url</span><span class="p">=</span><span class="s">r2dbc:mysql://localhost:3306</span>
<span class="py">spring.r2dbc.username</span><span class="p">=</span><span class="s">username</span>
<span class="py">spring.r2dbc.password</span><span class="p">=</span><span class="s">*********</span>
<span class="c">#liquibase
</span><span class="py">spring.liquibase.url</span><span class="p">=</span><span class="s">jdbc:mysql://localhost:3306/${stacksaga.admin.database-name}?createDatabaseIfNotExist=true}</span>
<span class="py">spring.liquibase.user</span><span class="p">=</span><span class="s">${spring.r2dbc.username}</span>
<span class="py">spring.liquibase.password</span><span class="p">=</span><span class="s">${spring.r2dbc.password}</span>
<span class="c">#logging
</span><span class="py">logging.level.root</span><span class="p">=</span><span class="s">info</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For managing Database versions, <a href="https://www.liquibase.org"><code>liquibase</code></a> has been used for StackSaga Admin server.
And also for accessing the database in reactive mode,
<a href="https://spring.io/projects/spring-data-r2dbc"><code>R2DBC</code></a> has been used.
Due to reactive has no any framework for managing database versions, StackSaga team has used both dependencies together.
That&#8217;s two database configurations should be configured here for the same database.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to add more configurations regarding the database and many more, please follow the spring reference documentation.
Because all other configurations will be applied according to the spring boot framework.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="stacksaga_admin_source"><a class="anchor" href="#stacksaga_admin_source"></a>4.1.3. StackSaga Admin Source Code</h4>
<div class="paragraph">
<p>If you want to build the StackSaga Admin Server standalone jar from scratch, you can use the <strong>stack-saga-admin</strong> repository on <a href="https://github.com/stacksaga/stack-saga-admin">GitHub</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dashboard_initialize"><a class="anchor" href="#dashboard_initialize"></a>4.2. Initialize Dashboard</h3>
<div class="paragraph">
<p><strong>Step-1.</strong><br>
After successfully running the server, Initially you can see <strong>Admin-initialization-key</strong> in the console like below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Admin-initialization-key-StackSaga.png" alt="admin initialization key In StackSaga" height="300">
</div>
</div>
<div class="paragraph">
<p><strong>Step-2.</strong><br>
Copy the key and go to the admin dashboard <code>http://localhost:4444</code> and enter the code click the button <strong><code>Initialize the server</code></strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Admin-initialization-page-StackSaga.png" alt="admin initialization page StackSaga" height="300">
</div>
</div>
<div class="paragraph">
<p><strong>Step-3.</strong><br>
Enter the super admin details create a new <strong>Super-Admin</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Stacksaga-Admin-Server-Super-Admin-Create-page.png" alt="Super Admin Create - StackSaga" height="300">
</div>
</div>
<div class="paragraph">
<p><strong>Step-4.</strong><br>
Login with the credentials that provided.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Stacksaga-Admin-Server-Admin-login-page.png" alt="Admin login page - StackSaga" height="300">
</div>
</div>
<div class="paragraph">
<p><strong>Step-5.</strong><br>
<em>Congratulations!</em> now you have successfully finished the initialization process.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/Stacksaga-Admin-Server-Super-Admin-page.png" alt="Admin Dashboard - StackSaga" height="300">
</div>
</div>
</div>
<div class="sect2">
<h3 id="create_api_gateway_user"><a class="anchor" href="#create_api_gateway_user"></a>4.3. Create API Gateway User</h3>
<div class="paragraph">
<p>To communicate individual services with the admin, StackSaga Connect should be used and therefore, to protect the <strong><code>/stacksaga</code></strong> endpoints, StackSaga shield also should be used.
To use the StackSaga shield with the api gateway, we have to create a <strong><code>ROLE_GATEWAY</code></strong> user and get the credentials.
Let&#8217;s go to the StackSaga Admin dashboard and create a new user for a new api-gateway step by step.<br>
Read <a href="#stacksaga_high_level">StackSaga architecture in high-level</a> page to get the idea how to behave the ecosystem.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to the <strong>user&#8217;s</strong> page and select the <strong>Registration</strong> tab to register the new api gateway user.<br></p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/create-ROLE-GATEWAY-step-1.png" alt="StackSaga High-level architecture" height="300">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Before adding the gateway user, we have to create a new api-gateway (because in the StackSaga system, one api-gateway-can have multiple gateway-users.)<br></p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/create-ROLE-GATEWAY-step-2.png" alt="StackSaga High-level architecture" height="300">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>After entering the user data, you will have a generated password by the StackSaga admin.
Save the username and the password in a secret file.
It is the credential that we want use for the shield congregation properties.<br></p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/create-ROLE-GATEWAY-step-3.png" alt="StackSaga High-level architecture" height="300">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>you can see the new user in the list.<br></p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/img/create-ROLE-GATEWAY-step-4.png" alt="StackSaga High-level architecture" height="300">
</div>
</div>
</div>
<div class="sect2">
<h3 id="create_service_user"><a class="anchor" href="#create_service_user"></a>4.4. Create Service User</h3>

</div>
<div class="sect2">
<h3 id="create_operator_user"><a class="anchor" href="#create_operator_user"></a>4.5. Create Operator User</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="stacksaga_core_index"><a class="anchor" href="#stacksaga_core_index"></a>5. StackSaga Starter Core</h2>
<div class="sectionbody">
<div class="paragraph">
<p>StackSaga core dependency consists of many modules and topics like
<a href="#creating_aggregator_class">Aggregator</a>, <a href="#saga_executors">Executors</a>, and <a href="#saga_revert_hint_store">RevertHintStore</a> many more.
You can go through each topic to have comprehensive knowledge.</p>
</div>
<div class="paragraph">
<p>To use the <code>StackSaga core</code> dependency in your application you need to add the dependency in your application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven Dependency</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.stacksaga<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>stacksaga-spring-boot-starter-core<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For your convenience, all the configuration details have been mentioned here.</p>
</div>
<div class="sect2">
<h3 id="creating_aggregator_class"><a class="anchor" href="#creating_aggregator_class"></a>5.1. Creating Aggregator Class</h3>
<div class="paragraph">
<p>The aggregator<sup><a href="#aggregator_architecture">ref</a></sup>  class does represent your business domain, and it is the container for carrying out the data for the executors.
In side of the aggregator class, you should provide all the data regarding your entire transaction.</p>
</div>
<div class="paragraph">
<p>example: Just think you are will be to make a transaction for place and order by using StackSaga.
then you have to create an Aggregator class to put the data that you want to while the whole process.
you can create an Aggregator class called <code>PlaceOrderAggregator</code> and provide all the data that you want like <em>username,
orderId, transactionId</em> etc&#8230;&#8203;
and also you might want
to add complex data structure inside that aggregator class like <em>list of items</em> regarding the items that the customer&#8217;s order.
then you have to create a java pojo as well.
as a best practice,
the framework suggests you
to create all related pojo classes in the same package of the Aggregator class or as the inner classes of the Aggregator class.</p>
</div>
<div class="paragraph">
<p>To be an aggregator in StackSaga, Mainly, The aggregator class should be extended from <code>org.stacksaga.Aggregator</code> class and also the aggregator class should be annotated with <code>org.stacksaga.core.annotation.SagaAggregator</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
All the classes (main aggregator class and other classes that are used inside it) that are used for the SagaAggregator should be implemented by the <code>java.io.Serializable</code> class.
By default, The main aggregator class is Serializable due to the fact that it is implemented from the <code>Aggregator</code> class. <a href="#complex_aggrgator">See complex object implementation</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see how it is created in StackSaga project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaAggregator</span><span class="o">(</span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="n">version</span> <span class="o">=</span> <span class="nd">@SagaAggregatorVersion</span><span class="o">(</span><span class="n">major</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="mi">1</span><span class="o">),</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">idPrefix</span> <span class="o">=</span> <span class="s">"po"</span><span class="o">,</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"PlaceOrderAggregator"</span><span class="o">,</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">sagaSerializable</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorSample</span><span class="o">.</span><span class="na">class</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="o">)</span>
<span class="nd">@Getter</span> <i class="conum" data-value="6"></i><b>(6)</b>
<span class="nd">@Setter</span> <i class="conum" data-value="7"></i><b>(7)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregator</span> <span class="kd">extends</span> <span class="nc">Aggregator</span>  <span class="o">{</span> <i class="conum" data-value="8"></i><b>(8)</b>

    <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="kd">public</span> <span class="nf">PlaceOrderAggregator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">isActive</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The aggregator class should be annotated with <code>org.stacksaga.core.annotation.SagaAggregator</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>version</strong> will be used for the identification of the aggregator versioning. it is helpful for the <strong>event-upper-casting</strong> and <strong>event-down-casting</strong>. <code>org.stacksaga.core.annotation.SagaAggregatorVersion</code> annotation help you to provide the version of the aggregator.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>idPrefix</strong> will be used as the prefix of the transaction id. you can give a prefix according to the aggregator name.
The maximum length of the prefix is 4 characters.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>name</strong> The name of the aggregator. this is used for identification of the aggregator by the name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>sagaSerializable</strong> is used for pre-serialization of the samples of the aggregator. <a href="#saga_serializable">see the implementation</a></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><strong>Getter</strong> you can create getters as usual for the aggregator.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><strong>Setter</strong> you can create setters as usual for the aggregator.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The aggregator class should be implemented from the <code>org.stacksaga.Aggregator</code> class.
It provides the shep of aggregator in the framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The aggregator class should have the default constructor and also the <strong>super()</strong> method should be called by passing the same aggregator class.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The name of the aggregator should be the same forever.
Because, all the event-store data is mapped with the aggregator name.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Due to the fact that the aggregator name is configured by an attribute, you can change the package of the aggregator class anytime.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In StackSaga, The aggregator is not a spring bean at all.
Therefore, it is not necessary to have inside the <strong>component scan</strong> area.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="saga_serializable"><a class="anchor" href="#saga_serializable"></a>5.2. Creating SagaSerializable Class for Aggregator</h3>
<div class="paragraph">
<p>Providing sample objects for the framework is very important to capture the feature failures that can be occurred due to the version updates of the Aggregator.
You can have a better understanding of version updates through the following topics.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#version_casting_architecture">Version Casting Architecture</a>.</p>
</li>
<li>
<p><a href="#aggregators_event_casting">Aggregator&#8217;s Event Casting</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the implementation of <code>SagaSerializable</code> here:</p>
</div>
<div class="paragraph">
<p>The <code>SagaSerializable</code> class provides you a method called <code>&lt;T&gt; getSamples()</code> to provide the sample array of objects of your real Aggregator. for each aggregator class that you made should have a separate implementation of <code>SagaSerializable</code> for validating the sample object before the application is started. that process ensures that your aggregator object will not face a serialization error while the transactions are being processed in the production.</p>
</div>
<div class="paragraph">
<p>you can see a sample SagaSerializable <code>(PlaceOrderAggregatorSample.class)</code> implementation of the PlaceOrderAggregator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="hll"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregatorSample</span> <span class="kd">extends</span> <span class="nc">SagaSerializable</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
</span>    <span class="kd">public</span> <span class="nf">PlaceOrderAggregatorSample</span><span class="o">()</span> <span class="o">{</span>
<span class="hll">        <span class="c1">//sample-1</span>
</span><span class="hll">        <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">();</span>
</span>        <span class="n">aggregator1</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
<span class="hll">
</span><span class="hll">        <span class="k">this</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"1"</span><span class="o">,</span> <span class="n">aggregator1</span><span class="o">);</span><i class="conum" data-value="2"></i><b>(2)</b>
</span>
        <span class="c1">//sample-2</span>
        <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">();</span>
        <span class="n">aggregator2</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">aggregator2</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"mafei"</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"2"</span><span class="o">,</span> <span class="n">aggregator2</span><span class="o">);</span><i class="conum" data-value="2"></i><b>(2)</b>

        <span class="c1">//sample-3</span>
        <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">();</span>
        <span class="n">aggregator3</span><span class="o">.</span><span class="na">getItemDetails</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                <span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">ItemDetail</span>
                        <span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">itemName</span><span class="o">(</span><span class="s">"Item-01"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">price</span><span class="o">(</span><span class="mf">10.50</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">qty</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"3"</span><span class="o">,</span> <span class="n">aggregator3</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement your custom <code>PlaceOrderAggregatorSample</code> from the <code>SagaSerializable&lt;T&gt;</code>.
The generic type should be the aggregator that you wish to check the sample object.
According to the example, the Type is <code>PlaceOrderAggregator</code>.
Then you will have a method for providing the sample objects for that given type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Put your initialized sample objects for the validation process by using <code>put(key,vlaue)</code> method.
The key should be unique for each.
And also you have to provide at least one sample object.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure to keep the default constructor for each SagaSerializable implementation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="aggregator_mapper_implementation"><a class="anchor" href="#aggregator_mapper_implementation"></a>5.3. Custom Aggregator Mapper</h3>
<div class="paragraph">
<p>You can decide your custom configurations of the objectMapper for your target <a href="#creating_aggregator_class">Aggregator</a>.
By default, the system will use an <a href="https://fasterxml.github.io/jackson-databind/javadoc/2.7/com/fasterxml/jackson/databind/ObjectMapper.html"><code>ObjectMapper</code></a>
that the framework provides for the aggregator serialization and deserialization.
But if you want to customize the objectMapper for your target aggregator, you can create and provide a custom objectMapper object for the target aggregator by using <code>SagaAggregatorMapperProvider</code> implementation.
Then The framework will use the custom Aggregator Mapper that you provided to the target aggregator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The class should be a Spring bean (Annotate with <code>@Component</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here you can see a custom implementation of the <code>AggregatorMapper</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregatorJsonMapper</span> <span class="kd">implements</span> <span class="nc">SagaAggregatorMapperProvider</span>  <span class="o">{</span><i class="conum" data-value="2"></i><b>(2)</b>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PlaceOrderAggregatorJsonMapper</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="c1">//your custom object mapper configurations</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">SagaAggregatorMapper</span> <span class="nf">getSagaAggregatorMapper</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">SagaAggregatorMapper</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span>
                <span class="k">this</span><span class="o">.</span><span class="na">objectMapper</span>
        <span class="o">);</span><i class="conum" data-value="5"></i><b>(5)</b>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>@Component</strong>: Mark your custom object mapper implementation as a Spring bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>SagaAggregatorMapperProvider</strong>: Implement by the <code>SagaAggregatorMapperProvider</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initialize and set your custom configurations for the <code>objectMapper</code> object that you provide for the target aggregator.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Override the method for providing the <code>SagaAggregatorMapper</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>SagaAggregatorMapper.Builder</strong>: The builder class provides the methods for building <code>SagaAggregatorMapper</code> object.
you can build <code>SagaAggregatorMapper</code> object by adding your custom configured objectMapper object and return it back.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>SagaAggregatorMapper.Builder</code> class can have several build methods with several mapper types other than the <code>ObjectMapper</code>.
Currently, StackSaga framework only supports <code>ObjectMapper</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can provide your custom object <code>SagaAggregatorMapperProvider</code> class to the target Aggregator like below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaAggregator</span><span class="o">(</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nd">@SagaAggregatorVersion</span><span class="o">(</span><span class="n">major</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="mi">1</span><span class="o">),</span>
        <span class="n">idPrefix</span> <span class="o">=</span> <span class="s">"po"</span><span class="o">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"PlaceOrderAggregator"</span><span class="o">,</span>
        <span class="n">sagaSerializable</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorSample</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorJsonMapper</span><span class="o">.</span><span class="na">class</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="o">)</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregator</span> <span class="kd">extends</span> <span class="nc">Aggregator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">PlaceOrderAggregator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>mapper</strong>: provide your custom aggregator mapper provider class.</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="complex_aggrgator"><a class="anchor" href="#complex_aggrgator"></a>5.4. Full Aggregator implementation.</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="c1">//Aggregtor Classs</span>
<span class="nd">@SagaAggregator</span><span class="o">(</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nd">@SagaAggregatorVersion</span><span class="o">(</span><span class="n">major</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="mi">1</span><span class="o">),</span>
        <span class="n">idPrefix</span> <span class="o">=</span> <span class="s">"po"</span><span class="o">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"PlaceOrderAggregator"</span><span class="o">,</span>
        <span class="n">sagaSerializable</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorSample</span><span class="o">.</span><span class="na">class</span>
<span class="o">)</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregator</span> <span class="kd">extends</span> <span class="nc">Aggregator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">PlaceOrderAggregator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">isActive</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemDetail</span><span class="o">&gt;</span> <span class="n">itemDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="o">}</span>

<span class="c1">//Pojo Class for Item Details</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@Builder</span>
<span class="kd">class</span> <span class="nc">ItemDetail</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">itemName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">price</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">//Saga Serializable Class</span>
<span class="kd">class</span> <span class="nc">PlaceOrderAggregatorSample</span> <span class="kd">implements</span> <span class="nc">SagaSerializable</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">PlaceOrderAggregator</span><span class="o">[]</span> <span class="nf">getSamples</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//sample-1</span>
        <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">();</span>
        <span class="n">aggregator1</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
        <span class="c1">//sample-1</span>
        <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">();</span>
        <span class="n">aggregator2</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">aggregator2</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"mafei"</span><span class="o">);</span>
        <span class="c1">//sample-3</span>
        <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">();</span>
        <span class="n">aggregator3</span><span class="o">.</span><span class="na">getItemDetails</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                <span class="nc">ItemDetail</span>
                        <span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">itemName</span><span class="o">(</span><span class="s">"Item-01"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">price</span><span class="o">(</span><span class="mf">10.50</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">qty</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">[]{</span>
                <span class="n">aggregator1</span><span class="o">,</span>
                <span class="n">aggregator2</span><span class="o">,</span>
                <span class="n">aggregator3</span><span class="o">,</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It is necessary to be implemented by the  <code>Serializable</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="aggregator_serialization_and_deserialization"><a class="anchor" href="#aggregator_serialization_and_deserialization"></a>5.5. Aggregator Serialization And Deserialization</h3>
<div class="paragraph">
<p>By default, StackSaga uses <code>Jackson ObjectMapper</code> for aggregator serialization and deserialization.
Therefore, It is possible to do default casting subject to ObjectMapper in StackSaga.
To do that you are able to use all the <a href="https://javadoc.io/doc/com.fasterxml.jackson.core/jackson-annotations/latest/index.html">jackson-annotations</a> that are provided by the <code>Jackson ObjectMapper Library</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is recommended to use <code>@JsonProperty</code> annotation with a <strong>fixed-name</strong> for all the properties in your aggregator class.
It helps to keep the JSON properties safe from the Java codes in the event-store.<br>
The suggestion does not mean to keep the properties in <strong>SNAKE_CASE</strong> at all.
Therefore, it is not recommended to use <strong>SNAKE_CASE</strong> configuration for all the properties in your aggregator class.
Because it will be changed correspondingly to the property name every time you change the property name in the Java code.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaAggregator</span><span class="o">(</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nd">@SagaAggregatorVersion</span><span class="o">(</span><span class="n">major</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="mi">1</span><span class="o">),</span>
        <span class="n">idPrefix</span> <span class="o">=</span> <span class="s">"po"</span><span class="o">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"PlaceOrderAggregator"</span><span class="o">,</span>
        <span class="n">sagaSerializable</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorSample</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorJsonMapper</span><span class="o">.</span><span class="na">class</span>
<span class="o">)</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregator</span> <span class="kd">extends</span> <span class="nc">Aggregator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">PlaceOrderAggregator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"order_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"total"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Double</span> <span class="n">total</span><span class="o">;</span>
    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"is_active"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">isActive</span><span class="o">;</span>
    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"item_details"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemDetail</span><span class="o">&gt;</span> <span class="n">itemDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aggregators_event_casting"><a class="anchor" href="#aggregators_event_casting"></a>5.6. Aggregator&#8217;s Event Casting</h3>
<div class="paragraph">
<p>As per the architecture <a href="#version_casting_architecture">documentation</a> StackSag does support Aggregator Event <a href="#aggregator_oriented_up_casting">UpCast</a> and also Aggregator Event <a href="#aggregator_oriented_down_casting">DownCast</a>.<br>
For the upcasting of the Aggregator Event, there is nothing to be done.
The only thing is adding the new properties.
But the down-casting process is a little more complicated.</p>
</div>
<div class="paragraph">
<p>To overcome Aggregator&#8217;s Event down-casting in StackSaga, it can be followed in two different approaches technically.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ignore Unknown JSON Properties.</p>
</li>
<li>
<p>Collect Missing properties</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<strong>Ignore Unknown JSON Properties</strong> Is not a recommended approach.
Technically, it is possible to ignore the missing properties in Object Mapper by using <code>DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES</code> globally or using <code>@JsonIgnoreProperties(ignoreUnknown = true)</code>.
Annotation in class level.
But it is not recommended in StackSaga.
Because old events have more data that the new one when it provided down-casting changes in your aggregator.
Then, while the old events are processed, that removed data will not be available for accessing.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="collect_missing_properties"><a class="anchor" href="#collect_missing_properties"></a>5.6.1. Collect Missing properties</h4>
<div class="paragraph">
<p>For collecting missing properties it can be used <code>@JsonAnySetter</code> and <code>@JsonAnyGetter</code> with a custom method.
But you don&#8217;t need to create all the things from scratch.
Because StackSaga provides the helper class called <code>MissingJsonPropertyCollector</code> for extending without writing any custom methods.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The root implementation (Custom Aggregator) of the <strong>Aggregator</strong> is by default extended from <code>MissingJsonPropertyCollector</code>.
Therefore, the root Custom Aggregator class is ready to collect the missing properties.
But if you want to empower other inner classes that are used inside the Root Aggregator class also with Missing properties collector capabilities, you can extend all the inner classes from <code>MissingJsonPropertyCollector</code> as well.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example for down-casting with using <code>MissingJsonPropertyCollector</code> implementation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Old Version Of the Custom Aggregator.</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaAggregator</span><span class="o">(</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nd">@SagaAggregatorVersion</span><span class="o">(</span><span class="n">major</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="mi">0</span><span class="o">),</span>
        <span class="n">idPrefix</span> <span class="o">=</span> <span class="s">"po"</span><span class="o">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"PlaceOrderAggregator"</span><span class="o">,</span>
        <span class="n">sagaSerializable</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorSample</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorJsonMapper</span><span class="o">.</span><span class="na">class</span>
<span class="o">)</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregator</span> <span class="kd">extends</span> <span class="nc">Aggregator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">PlaceOrderAggregator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"order_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderId</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"total"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Double</span> <span class="n">total</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"is_active"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">isActive</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"comment"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">comment</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"item_details"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemDetail</span><span class="o">&gt;</span> <span class="n">itemDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Getter</span>
    <span class="nd">@Setter</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="nd">@NoArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ItemDetail</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"order_id"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">itemName</span><span class="o">;</span>

        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"qty"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">;</span>

        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"price"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">double</span> <span class="n">price</span><span class="o">;</span>

        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"note"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">note</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this <code>PlaceOrderAggregator</code> class you can see some properties in the root class, and also there is another nested class called <code>ItemDetail</code> and it contains more properties regarding the items.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>New Version Of the Custom Aggregator.</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaAggregator</span><span class="o">(</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nd">@SagaAggregatorVersion</span><span class="o">(</span><span class="n">major</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="mi">1</span><span class="o">),</span>
        <span class="n">idPrefix</span> <span class="o">=</span> <span class="s">"po"</span><span class="o">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"PlaceOrderAggregator"</span><span class="o">,</span>
        <span class="n">sagaSerializable</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorSample</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="nc">PlaceOrderAggregatorJsonMapper</span><span class="o">.</span><span class="na">class</span>
<span class="o">)</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderAggregator</span> <span class="kd">extends</span> <span class="nc">Aggregator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">PlaceOrderAggregator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"order_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderId</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"total"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Double</span> <span class="n">total</span><span class="o">;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"is_active"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">isActive</span><span class="o">;</span>

    <span class="c1">//@JsonProperty("comment") </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="c1">//private String comment;</span>

    <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"item_details"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemDetail</span><span class="o">&gt;</span> <span class="n">itemDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Getter</span>
    <span class="nd">@Setter</span>
    <span class="nd">@AllArgsConstructor</span>
    <span class="nd">@NoArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ItemDetail</span> <span class="kd">extends</span> <span class="nc">MissingJsonPropertyCollector</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"order_id"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">itemName</span><span class="o">;</span>

        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"qty"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">qty</span><span class="o">;</span>

        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"price"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">double</span> <span class="n">price</span><span class="o">;</span>

        <span class="c1">//@JsonProperty("note") </span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="c1">//private String note;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Relatively the old version, some attributes have been removed from the root class and also from the <code>ItemDetail</code> nested class.
That means that the old event data should be cast down when it is deserialized into the new aggregator class.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>comment</code> property has been removed from the root class.
But should not be executed from the <code>MissingJsonPropertyCollector</code>.
Because the root class is already executed from the <code>MissingJsonPropertyCollector</code> through the <code>Aggregator</code> class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>note</code> property has been removed from the <code>ItemDetail</code> class.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To be collected that missing property (<code>note</code>), the <code>ItemDetail</code> has been extended from the <code>MissingJsonPropertyCollector</code> class.
Then the deserialization is happened that missing property will be saved in to the <code>missingProperties</code> map in side of teh <code>MissingJsonPropertyCollector</code> that has been provided by the framework.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If the <code>ItemDetail</code> has not been extended from the <code>MissingJsonPropertyCollector</code> class, an exception will be thrown by the framework when the application is started by mapping the old version&#8217;s samples that you have given in the previous version through the <code><a href="#saga_serializable">SagaSerializable</a></code> implementation.
It will ensure that the application is in a casting trouble.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Getting The Collected Properties For specific Version.</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaExecutor</span><span class="o">(</span><span class="n">executeFor</span> <span class="o">=</span> <span class="s">"order-service"</span><span class="o">,</span> <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"OrderSaveExecutor"</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderSaveExecutor</span> <span class="kd">implements</span> <span class="nc">CommandExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManager</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">aggregator</span><span class="o">.</span><span class="na">getRealVersionAsString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"1.0.0"</span><span class="o">))</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="nc">String</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">aggregator</span><span class="o">.</span><span class="na">getMissingProperties</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"comment"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"comment = "</span> <span class="o">+</span> <span class="n">comment</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="nc">PlaceOrderAggregator</span><span class="o">.</span><span class="na">ItemDetail</span> <span class="n">itemDetail</span> <span class="o">:</span> <span class="n">aggregator</span><span class="o">.</span><span class="na">getItemDetails</span><span class="o">())</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="nc">String</span> <span class="n">note</span> <span class="o">=</span> <span class="n">itemDetail</span><span class="o">.</span><span class="na">getMissingProperties</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"note"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"note = "</span> <span class="o">+</span> <span class="n">note</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">...</span>

        <span class="k">return</span> <span class="n">stepManager</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">UpdateStockExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doRevert</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">NonRetryableExecutorException</span> <span class="n">e</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">RevertHintStore</span> <span class="n">revertHintStore</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You already know that you have to use the same aggregator as well as the same executors for invoking the old transactions as well.
Although the missing properties should not be need for the new version(<code>1.0.1</code>), If the event is an old transaction from the version of <code>1.0.0</code>, the missing properties can be required.
Therefore, it is necessary to identify the exact version of the execution (Event).
To identify the exact version of the current execution (Event), The framework provides the data version data along with the Room Aggregator Object By default.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check the current execution is 1.0.0 or another version by using the version data that provides by the Aggregator.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the version is <code>1.0.0</code>, you can get the missing properties from the <code>aggregator</code> object by calling <code>getMissingProperties()</code> method.
That pert is based on the root aggregator object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the version is <code>1.0.0</code>, you can get the missing properties from the <code>itemDetail</code> object by calling <code>getMissingProperties()</code> method.
That pert is based on the root <code>ItemDetail</code> object.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is possible to get the missing properties and the version of the current execution (Event) in every executor like <a href="#command_executor">Command-Executor</a>, <a href="#query_executor">Query-Executor</a> and <a href="#revert_after_executor">Revert-Executor</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="saga_executors"><a class="anchor" href="#saga_executors"></a>5.7. Saga Executors.</h3>
<div class="paragraph">
<p>According to the saga design pattern, sub processes (atomic executions) can have two executions called process execution and compensation execution.
And those executions you van create as the methods in your application anywhere.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong><a href="#query_executor">Query executors</a></strong>: If some atomic process has no compensation, that kind of process is used in a query executor.</p>
</li>
<li>
<p><strong><a href="#command_executor">Command executors</a></strong>:
If some atomic process has a compensation (revert execution), that kind of process is used in a command executor.<br>
<strong>Revert executors</strong>: For the compensation process of the command executor it can be used other sub processes if you need.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><strong><a href="#revert_before_executor">Revert Before Executors</a></strong>: If you want to execute an atomic process before executing the main revert process, you can create a Revert-Before-Executor.</p>
</li>
<li>
<p><strong><a href="#revert_after_executor">Revert After Executors</a></strong>: If you want to execute an atomic process after executing the main revert process, you can create a Revert-Before-Executor.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="query_executor"><a class="anchor" href="#query_executor"></a>5.7.1. Query Executor.</h4>
<div class="paragraph">
<p>You can create any number of your custom Query-Executors regarding the Aggregator.
Here you can see how you can create a Query-Executor for your <code><a href="#creating_aggregator_class">PlaceOrderAggregator</a></code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"user-service"</span><span class="o">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"CheckUserExecutor"</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckUserExecutor</span> <span class="kd">implements</span> <span class="nc">QueryExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span> <i class="conum" data-value="5"></i><b>(5)</b>

    <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManagerUtil</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>
        <span class="c1">//execute the service and check the conndtion.</span>

        <span class="c1">//return or throw </span><i class="conum" data-value="7"></i><b>(7)</b>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>@SagaExecutor</strong>: annotate your query executor with <code>@org.stacksaga.annotation.SagaExecutor</code> annotation.
The annotation provides the spring bean capabilities and also another metadata for the StackSaga framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>executeFor</strong>: The name of the service that particular executor is going to be connected. it can be a service name of another service. if the service is spring boot service, make sure to keep the application name as its. because it will be helpful for the retry process.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>liveCheck</strong>: When the retry process is executed, liveCheck is considered by the engine. if the target service is a spring boot service or registered service with the service registry, the availability is checked before executing the retry by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>value</strong>: The bean name of the executor.
The executor is identified with this value by StackSaga engine. after configuring the bean name, it cannot be changed at all. if you want to the class package, it does not matter without changing the configured name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>QueryExecutor&lt;T&gt;</strong> IF the executor is Query one, The executor should be implemented by <code>org.stacksaga.executor.QueryExecutor&lt;T&gt;</code>. <code>T</code> should be the target Aggregator class for the domain.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Override the <code>doProcess()</code>  method and put your execution code block that should be executed when the executor is executed by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Finally, you can either return the next executor with the method that provides by the <code>ProcessStepManager</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="command_executor"><a class="anchor" href="#command_executor"></a>5.7.2. Command Executor.</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"delivery-service"</span><span class="o">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"DispatchOrderExecutor"</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatchOrderExecutor</span> <span class="kd">implements</span> <span class="nc">CommandExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span> <i class="conum" data-value="5"></i><b>(5)</b>

    <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span> <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span> <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManager</span> <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>
        <span class="c1">//execute the service and check the conndtion.</span>
        <span class="o">...</span>
        <span class="c1">//return or throw </span><i class="conum" data-value="10"></i><b>(10)</b>
    <span class="o">}</span>

    <span class="nd">@RevertBefore</span><span class="o">(</span><span class="n">startFrom</span> <span class="o">=</span> <span class="nc">DispatchRevertNotifierExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <i class="conum" data-value="11"></i><b>(11)</b>
    <span class="nd">@RevertAfter</span><span class="o">(</span><span class="n">startFrom</span> <span class="o">=</span> <span class="nc">DispatchRevertCompleteLogExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <i class="conum" data-value="12"></i><b>(12)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doRevert</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span><i class="conum" data-value="13"></i><b>(13)</b>
            <span class="nc">NonRetryableExecutorException</span> <span class="n">nonRetryableExecutorException</span><span class="o">,</span><i class="conum" data-value="14"></i><b>(14)</b>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span> <i class="conum" data-value="15"></i><b>(15)</b>
            <span class="nc">RevertHintStore</span> <span class="n">revertHintStore</span> <i class="conum" data-value="16"></i><b>(16)</b>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span> <span class="o">{</span>
        <span class="c1">//call the atomic process that you want to as the compensation,</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>@SagaExecutor</strong>: annotate your query executor with <code>@org.stacksaga.annotation.SagaExecutor</code> annotation.
The annotation provides the spring bean capabilities and also another metadata for the StackSaga framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>executeFor</strong>: The name of the service that particular executor is going to be connected. it can be a service name of another service. if the service is spring boot service, make sure to keep the application name as its. because it will be helpful for the retry process.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>liveCheck</strong>: When the retry process is executed, liveCheck is considered by the engine. if the target service is a spring boot service or registered service with the service registry, the availability is checked before executing the retry by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>value</strong>: The bean name of the executor.
The executor is identified with this value by StackSaga engine. after configuring the bean name, it cannot be changed at all. if you want to the class package, it does not matter without changing the configured name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>CommandExecutor&lt;T&gt;</strong> IF the executor is command one, The executor should be implemented by <code>org.stacksaga.executor.CommandExecutor&lt;T&gt;</code>. <code>T</code> should be the target Aggregator class for the domain.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Override the <code>doProcess()</code>  method and put your execution code block that should be executed when the executor is executed by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><strong>ProcessStack</strong> Object provides all the executed execution until the process so far.
It will help for gen an idea about the execution history.
And also you can get the decision of the execution base on the execution history.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><strong>PlaceOrderAggregator</strong>: The current aggregator state.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><strong>ProcessStepManagerUtil&lt;T&gt;</strong>: This object provides the methods for giving the navigation to the engine regarding the next step. it can be another executor (command or query) or a process completion.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Inside the method scope, you can provide the execution that should be executed when the StackSaga engine executes.
And finally you can navigate to the next step by using the <code>ProcessStepManagerUtil</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td><strong>@RevertBefore</strong>: If the executor has any revert-before-executors, you can mention that executor class with <code>@RevertBefore</code> annotation.
According to the example, the revert before execution will be started from <a href="#revert_before_executor">DispatchRevertNotifierExecutor</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td><strong>@RevertAfter</strong>: If the executor has any revert-after-executors, you can mention that executor class with <code>@RevertAfter</code> annotation.
According to the example, the revert after execution will be started from <a href="#revert_after_executor">DispatchRevertCompleteLogExecutor</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td><strong>ProcessStack</strong> The final process stack that was when the final execution was executed.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td><strong>NonRetryableExecutorException</strong> The exception that caused the transition process stopping to forward.</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td><strong>PlaceOrderAggregator</strong> The final aggregator state when the NonRetryableExecutorException is thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td><strong>RevertHintStore</strong> If you want to add some data to the backward process, you can use the <code>RevertHintStore</code> to put the data.</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="revert_before_executor"><a class="anchor" href="#revert_before_executor"></a>5.7.3. Revert Before Executor.</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"delivery-service"</span><span class="o">,</span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"DispatchRevertNotifierExecutor"</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatchRevertNotifierExecutor</span> <span class="kd">implements</span> <span class="nc">RevertBeforeExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">,</span> <span class="nc">DispatchOrderExecutor</span><span class="o">&gt;</span> <span class="o">{</span><i class="conum" data-value="5"></i><b>(5)</b>

    <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">RevertBeforeStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">,</span> <span class="nc">DispatchOrderExecutor</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span><i class="conum" data-value="7"></i><b>(7)</b>
            <span class="nc">ProcessStack</span> <span class="n">previousProcessStack</span><span class="o">,</span><i class="conum" data-value="8"></i><b>(8)</b>
            <span class="nc">NonRetryableExecutorException</span> <span class="n">processException</span><span class="o">,</span><i class="conum" data-value="9"></i><b>(9)</b>
            <span class="nc">RevertHintStore</span> <span class="n">revertHintStore</span><span class="o">,</span><i class="conum" data-value="10"></i><b>(10)</b>
            <span class="nc">RevertBeforeStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">,</span> <span class="nc">DispatchOrderExecutor</span><span class="o">&gt;</span> <span class="n">revertStepManagerUtil</span> <i class="conum" data-value="11"></i><b>(11)</b>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span> <span class="o">{</span> <i class="conum" data-value="12"></i><b>(12)</b>
        <span class="k">return</span> <span class="n">revertStepManagerUtil</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">NextBeforExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <i class="conum" data-value="13"></i><b>(13)</b>
        <span class="c1">//or</span>
        <span class="k">return</span> <span class="n">revertStepManagerUtil</span><span class="o">.</span><span class="na">complete</span><span class="o">();</span> <i class="conum" data-value="14"></i><b>(14)</b>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>@SagaExecutor</strong>: annotate your query executor with <code>@org.stacksaga.annotation.SagaExecutor</code> annotation.
The annotation provides the spring bean capabilities and also another metadata for the StackSaga framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>executeFor</strong>: The name of the service that particular executor is going to be connected. it can be a service name of another service. if the service is spring boot service, make sure to keep the application name as its. because it will be helpful for the retry process.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>liveCheck</strong>: When the retry process is executed, liveCheck is considered by the engine. if the target service is a spring boot service or registered service with the service registry, the availability is checked before executing the retry by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>value</strong>: The bean name of the executor.
The executor is identified with this value by StackSaga engine. after configuring the bean name, it cannot be changed at all. if you want to the class package, it does not matter without changing the configured name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>RevertBeforeExecutor&lt;A, E&gt;</strong>: The Revert Before Executor should be implemented from the <code>RevertBeforeExecutor&lt;A,E&gt;</code>.
Generic <strong>A</strong> is the aggregator.
Generic <strong>E</strong> is the <a href="#command_executor">command-executor</a> of the given aggregator as the Generic <strong>A</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Override the <code>doProcess()</code> method that <code>RevertBeforeExecutor</code> provides.
That is the method is executed by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><strong>PlaceOrderAggregator</strong>: The final aggregator state when the process exception is thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><strong>ProcessStack</strong>: The final process stack when the process exception is thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><strong>NonRetryableExecutorException</strong>:The process-exception that was thrown by the last executor.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td><strong>RevertHintStore</strong> If you want to add some data to the backward process, you can use the <code>RevertHintStore</code> to put the data as container.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td><strong>RevertBeforeStepManagerUtil&lt;A, E&gt;</strong>: This object provides the methods for giving the navigation to the engine regarding the next step. it can be another revert-before-executor or a revert-before completion.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td><strong>RetryableExecutorException</strong>: If the revert before execution is failed due to a retryable exception, you can provide that by warping with <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td><strong>next()</strong>: You can provide (only if you have) the next revert-before-executor with <code>revertStepManagerUtil.next()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td><strong>complete()</strong>: If you don&#8217;t have any revert-before-executor to be executed as next regarding the command-executor, you can return <code>revertStepManagerUtil.complete()</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="revert_after_executor"><a class="anchor" href="#revert_after_executor"></a>5.7.4. Revert After Executor.</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"delivery-service"</span><span class="o">,</span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"DispatchRevertNotifierExecutor"</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatchRevertCompleteLogExecutor</span> <span class="kd">implements</span> <span class="nc">RevertAfterExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">,</span> <span class="nc">DispatchOrderExecutor</span><span class="o">&gt;</span> <span class="o">{</span><i class="conum" data-value="5"></i><b>(5)</b>

    <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">RevertAfterStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">,</span> <span class="nc">DispatchOrderExecutor</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span><i class="conum" data-value="7"></i><b>(7)</b>
            <span class="nc">ProcessStack</span> <span class="n">previousProcessStack</span><span class="o">,</span><i class="conum" data-value="8"></i><b>(8)</b>
            <span class="nc">NonRetryableExecutorException</span> <span class="n">processException</span><span class="o">,</span><i class="conum" data-value="9"></i><b>(9)</b>
            <span class="nc">RevertHintStore</span> <span class="n">revertHintStore</span><span class="o">,</span><i class="conum" data-value="10"></i><b>(10)</b>
            <span class="nc">RevertAfterStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">,</span> <span class="nc">DispatchOrderExecutor</span><span class="o">&gt;</span> <span class="n">revertStepManagerUtil</span> <i class="conum" data-value="11"></i><b>(11)</b>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span> <span class="o">{</span> <i class="conum" data-value="12"></i><b>(12)</b>
        <span class="k">return</span> <span class="n">revertStepManagerUtil</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">NextAfterExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <i class="conum" data-value="13"></i><b>(13)</b>
        <span class="c1">//or</span>
        <span class="k">return</span> <span class="n">revertStepManagerUtil</span><span class="o">.</span><span class="na">complete</span><span class="o">();</span> <i class="conum" data-value="14"></i><b>(14)</b>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>@SagaExecutor</strong>: annotate your query executor with <code>@org.stacksaga.annotation.SagaExecutor</code> annotation.
The annotation provides the spring bean capabilities and also another metadata for the StackSaga framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>executeFor</strong>: The name of the service that particular executor is going to be connected. it can be a service name of another service. if the service is spring boot service, make sure to keep the application name as its. because it will be helpful for the retry process.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>liveCheck</strong>: When the retry process is executed, liveCheck is considered by the engine. if the target service is a spring boot service or registered service with the service registry, the availability is checked before executing the retry by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>value</strong>: The bean name of the executor.
The executor is identified with this value by StackSaga engine. after configuring the bean name, it cannot be changed at all. if you want to the class package, it does not matter without changing the configured name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>RevertAfterExecutor&lt;A, E&gt;</strong>: The Revert After Executor should be implemented from the <code>RevertAfterExecutor&lt;A,E&gt;</code>.
Generic <strong>A</strong> is the aggregator.
Generic <strong>E</strong> is the <a href="#command_executor">command-executor</a> of the given aggregator as the Generic <strong>A</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Override the <code>doProcess()</code> method that <code>RevertAfterExecutor</code> provides.
That is the method is executed by the StackSaga engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><strong>PlaceOrderAggregator</strong>: The final aggregator state when the process exception is thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><strong>ProcessStack</strong>: The final process stack when the process exception is thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><strong>NonRetryableExecutorException</strong>:The process-exception that was thrown by the last executor.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td><strong>RevertHintStore</strong> If you want to add some data to the backward process, you can use the <code>RevertHintStore</code> to put the data as container.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td><strong>RevertAfterStepManagerUtil&lt;A, E&gt;</strong>: This object provides the methods for giving the navigation to the engine regarding the next step. it can be another revert-after-executor or a revert-after completion.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td><strong>RetryableExecutorException</strong>: If the revert after execution is failed due to a retryable exception, you can provide that by warping with <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td><strong>next()</strong>: You can provide (only if you have) the next revert-after-executor with <code>revertStepManagerUtil.next()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td><strong>complete()</strong>: If you don&#8217;t have any revert-after-executor to be executed as next regarding the command-executor, you can return <code>revertStepManagerUtil.complete()</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processstack"><a class="anchor" href="#_processstack"></a>5.8. ProcessStack</h3>

</div>
<div class="sect2">
<h3 id="retryable_executor_exception"><a class="anchor" href="#retryable_executor_exception"></a>5.9. RetryableExecutorException</h3>
<div class="paragraph">
<p>If you are having an exception while processing the executor due to a connection issue or that kind of re-invokable error (The exceptions that can be occurred temporarily), you can throw a <code>RetryableExecutorException</code>.
Then the StackSaga engine will temporarily pause the execution, and the transaction does expose to the next scheduler.
Because, the engine knows that even though the executor has an exception at this moment, the execution can be retried and run again successfully due to the retractable error.
IF you were unable to catch the exception properly, the execution might throw <code>RuntimeException</code> s.
That kind of unhandled exception will be caught as non-retryable exception by the StackSaga engine.
IF the exception is a <strong>non-retryable</strong> error, you can throw it by warping with <a href="#non_retryable_executor_exception"><code>NonRetryableExecutorException</code></a>.</p>
</div>
<div class="paragraph">
<p><strong>Retryable Executor Exceptions</strong> are allowed for the following executors.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Executor</th>
<th class="tableblock halign-left valign-top">DoProcess() Method</th>
<th class="tableblock halign-left valign-top">doRevert() Method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Command Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revert Before Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revert After Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is very important to identify whether the exception is a retryable exception or not.
If you don&#8217;t identify the exceptions that are thrown when the execution is executed every time that an exception is thrown, the transaction will be stopped to forward.
Therefore, it is necessary to capture and identify all the exceptions that are thrown inside the <code>doProcess()</code> method.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"user-service"</span><span class="o">,</span>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"CheckUserExecutor"</span>
<span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckUserExecutor</span> <span class="kd">implements</span> <span class="nc">QueryExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManagerUtil</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>

        <span class="k">try</span> <span class="o">{</span>

            <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">UserDetailDto</span><span class="o">&gt;</span> <span class="n">userDetail</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">userService</span><span class="o">.</span><span class="na">getUserDetail</span><span class="o">(</span><span class="n">aggregator</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
            <span class="o">...</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FeignException</span><span class="o">.</span><span class="na">ServiceUnavailable</span> <span class="n">unavailableException</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="nc">RetryableExecutorException</span><span class="o">.</span><span class="na">buildWith</span><span class="o">(</span><span class="n">unavailableException</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="non_retryable_executor_exception"><a class="anchor" href="#non_retryable_executor_exception"></a>5.10. NonRetryableExecutorException</h3>
<div class="paragraph">
<p>If you are having an exception while processing the executor that is not temporally occurred (The exceptions that have not any point of executing again), you can throw a <code>NonRetryableExecutorException</code>.
Then the StackSaga engine will stop the execution forward, and start reverting back, according to the configuration.</p>
</div>
<div class="paragraph">
<p>IF you were unable to catch the exception properly, the execution might throw <code>RuntimeException</code> s.
That kind of unhandled exception will be caught as <strong>non-retryable</strong> exception by the StackSaga engine as well.
But if you want to have proper error handling, you have to catch exceptions properly.</p>
</div>
<div class="paragraph">
<p><strong>Non-Retryable Executor Exceptions</strong> are allowed for the following executors.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Executor</th>
<th class="tableblock halign-left valign-top">DoProcess() Method</th>
<th class="tableblock halign-left valign-top">doRevert() Method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✖</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Command Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✖</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revert Before Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✖</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revert After Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✖</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can see in the summary table, all the revert executions are not allowed <code>NonRetryableExecutorException</code> s.
The reason for that is according to the StackSaga architecture, any <strong>command-execution</strong> can have revert execution (compensation execution).
But all the <strong>revert-executions</strong> can have retryable-exception only.
Because, even though the process can be failed, the revert execution cannot be failed at all.
If the process is failed, there is a revert execution to have a compensation.
But if the revert is failed, there are any other executions to have compensation for the reverting fail.<br>
<strong>The summary is that only forward execution can have non-retryable-exception.</strong>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"user-service"</span><span class="o">,</span>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"CheckUserExecutor"</span>
<span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckUserExecutor</span> <span class="kd">implements</span> <span class="nc">QueryExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManagerUtil</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>

        <span class="k">try</span> <span class="o">{</span>

            <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">UserDetailDto</span><span class="o">&gt;</span> <span class="n">userDetail</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">userService</span><span class="o">.</span><span class="na">getUserDetail</span><span class="o">(</span><span class="n">aggregator</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
            <span class="o">...</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FeignException</span><span class="o">.</span><span class="na">ServiceUnavailable</span> <span class="n">unavailableException</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="nc">RetryableExecutorException</span>
                    <span class="o">.</span><span class="na">buildWith</span><span class="o">(</span><span class="n">unavailableException</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FeignException</span><span class="o">.</span><span class="na">BadRequest</span> <span class="n">badRequestException</span><span class="o">)</span> <span class="o">{</span>
            <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="k">throw</span> <span class="nc">NonRetryableExecutorException</span>
                    <span class="o">.</span><span class="na">buildWith</span><span class="o">(</span><span class="n">badRequestException</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"time"</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">())</span>  <i class="conum" data-value="2"></i><b>(2)</b>
                    <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"reason"</span><span class="o">,</span> <span class="s">"BadRequest"</span><span class="o">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
                    <span class="o">...</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>NonRetryableExecutorException</strong> is thrown due to the exception is a <code>BadRequest</code>. specially <code>NonRetryableExecutorException</code> provides a way to add the metadata regarding the exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Put the metadata regarding exception as a key and value. <a id="stacksaga_exception_wrapping"></a></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In java, we usually pass the data regarding the exception with the exception object.
But in the StackSaga it is <strong>not recommended</strong>.
Because, any time any object can be serialized (even Exceptions) for saving to the event-store.
Serializing an exception object (like Json or XML) is not easy, and it might be a performance issue without any benefit.
And also most of the time if you pass a complex exception, it might throw an exception when it is serialized.
Therefore, StackSaga engine just saves your exception as a string in the event-store(Only for seeing through the Admin-Dashboard).
If you want to put some metadata to the backward regarding the exception,
<strong>NonRetryableExecutorException</strong> has a method to put the data as key and value pare called <code>put(key, value)</code>.
You can put any number of key/value pare into that by using the put method.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
There is nothing like you can throw an exception when some exception is occurred.
If you don&#8217;t want to continue the execution of the transaction to forward, and if you decide that the transaction should be stopped at some point, due to a condition is not met, you can throw a <strong>NonRetryableExecutorException</strong> exception as well.
<a href="#usage_of_exceptions">See the full implementation</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="usage_of_exceptions"><a class="anchor" href="#usage_of_exceptions"></a>5.11. Usage of Executors[Q&amp;C] With Exceptions </h3>
<div class="paragraph">
<p>Here you can see how you can handle the <strong>success</strong>,
<strong>failure</strong> and <strong>retryable</strong> scenario inside the <strong><a href="#query_executor">query-executor</a></strong> executor.
In the same way, you can handle all things in <strong><a href="#command_executor">command-executor</a></strong> as well.</p>
</div>
<div class="paragraph">
<p>Create your own exception annotating with <code><a href="#saga_exception_annotation">@SagaException</a></code>  class to handle to inactive user exception.</p>
</div>
<div class="paragraph">
<p>The executor gets the userdata from the user-service by calling another service.
Based on the return of the <code>userService.getUserDetail</code>  method, the next step is managed here.
If the user is in active mode, The current executor allows the next executor by providing the next executor that should be invoked to the StackSaga engine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"user-service"</span><span class="o">,</span>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"CheckUserExecutor"</span>
<span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckUserExecutor</span> <span class="kd">implements</span> <span class="nc">QueryExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManagerUtil</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">UserDetailDto</span><span class="o">&gt;</span> <span class="n">userDetail</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">userService</span><span class="o">.</span><span class="na">getUserDetail</span><span class="o">(</span><span class="n">aggregator</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userDetail</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">getIsActive</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">stepManagerUtil</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="nc">DispatchOrderExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">UserInactiveException</span> <span class="n">inactiveException</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserInactiveException</span><span class="o">(</span><span class="s">"User is not active!"</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="k">throw</span> <span class="nc">NonRetryableExecutorException</span>
                        <span class="o">.</span><span class="na">buildWith</span><span class="o">(</span><span class="n">inactiveException</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FeignException</span><span class="o">.</span><span class="na">ServiceUnavailable</span> <span class="n">unavailableException</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="nc">RetryableExecutorException</span>
                    <span class="o">.</span><span class="na">buildWith</span><span class="o">(</span><span class="n">unavailableException</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FeignException</span><span class="o">.</span><span class="na">BadRequest</span> <span class="n">badRequestException</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="nc">NonRetryableExecutorException</span>
                    <span class="o">.</span><span class="na">buildWith</span><span class="o">(</span><span class="n">badRequestException</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"reason"</span><span class="o">,</span> <span class="s">"BadRequest"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>Success scenario</strong>:
If the user is active, the next executor will be provided to the engine by using <code>stepManagerUtil.next()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Failed scenario</strong>:
IF the user is inactive, the process is stopped to forward by throwing <code>NonRetryableExecutorException</code> with <code>UserInactiveException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>Failed scenario</strong>:
IF the <code>userService.getUserDetail()</code> service throw a <code>FeignException.BadRequest</code> exception, the process is stopped to forward by throwing <code>NonRetryableExecutorException</code> with <code>FeignException.BadRequest</code> that occurred.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>Retryable scenario</strong>
IF the <code>userService.getUserDetail()</code> service throw a <code>FeignException.ServiceUnavailable</code> exception, the process is stopped temporally by throwing <code>NonRetryableExecutorException</code> with <code>FeignException.ServiceUnavailable</code> that occurred.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="saga_exception_annotation"><a class="anchor" href="#saga_exception_annotation"></a>5.12. @SagaException Annotation </h3>
<div class="paragraph">
<p>If you want to throw an exception as a <a href="#non_retryable_executor_exception">NonRetryableExecutorException</a>, The framework suggests you to create a new exception for that by warping the real exception and specially that can be annotated with <code>@SagaException</code> annotation like below.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Make sure to don&#8217;t add the variables for exception metadata in your new exception class.
Keep the exception class clear.
Because, the framework does provide another way to provide the metadata in <a href="#stacksaga_exception_wrapping">NonRetryableExecutorException</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaException</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"UserInactiveException"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserInactiveException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
    <span class="c1">//for just throw an exception.</span>
    <span class="kd">public</span> <span class="nf">UserInactiveException</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="c1">//for just throw an exception with message.</span>
    <span class="kd">public</span> <span class="nf">UserInactiveException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//for wrapping the exception.</span>
    <span class="kd">public</span> <span class="nf">UserInactiveException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>According to the <a href="#usage_of_exceptions">usage of exceptions example</a>, you can see this exception is used to throw if the user is inactive.
And also if you think the package of the exception class will be changed in some cases in the future, you can set a fixed name for the exception.
By annotating <code>@SagaException</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At the first glance, you might think that there is no point in annotating by <code>@SagaException</code> when it is thrown.
However, it is important when it is used in the revert executions (revert execution of the <a href="#command_executor">command executors</a> or <a href="#revert_after_executor">revert after</a> or <a href="#revert_before_executor">revert before</a>).
As you know, the revert process goes through revert method of each and every <a href="#command_executor">command executors</a> that successfully executed in the past regarding the transaction.
Then you have to check what is the real exception that was thrown, and what is the metadata that you want to make the decisions.
As an example, just imagine that there is an event in the event-store to be executed.
While the event is in the event-store, a new version is released of the particular service.
And also the exception class has been moved to another package by mistake, or as a requirement.
But while then, the old event is trying to be invoked through the StackSaga engine with old data.
However, At this moment the exception class that caused the exception does not exist in the path when the exception was thrown initially.</p>
</div>
<div class="paragraph">
<p>you can use the following methods that <code>NonRetryableExecutorException</code> does provide for checking the exception in the revert process.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>getRealExceptionName()</code>: Get the name with the path of the exception class that was thrown.
(This name is provided by the framework when the exception is thrown).</p>
</li>
<li>
<p><code>getRealExceptionSimpleName()</code>: Get just the name of the exception class that was thrown.
(This name is provided by the framework when the exception is thrown).</p>
</li>
<li>
<p><code><strong>getRealSagaExceptionName()</strong></code>: Get the name that has been given with <code>@SagaException</code> annotation.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can get the <code>Real Saga Exception Name</code> only if you have annotated with <code>@SagaException</code> annotation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here you can see an example of how you can use <code>SagaException</code> in the revert process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"stock-management-service"</span><span class="o">,</span>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"UpdateStockExecutor"</span>
<span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UpdateStockExecutor</span> <span class="kd">implements</span> <span class="nc">CommandExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManager</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doRevert</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">previousProcessStack</span><span class="o">,</span>
            <span class="nc">NonRetryableExecutorException</span> <span class="n">realException</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">finalAggregatorState</span><span class="o">,</span>
            <span class="nc">RevertHintStore</span> <span class="n">revertHintStore</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span> <span class="o">{</span>

        <span class="n">realException</span><span class="o">.</span><span class="na">getRealSagaExceptionName</span><span class="o">().</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">realSagaExceptionName</span> <span class="o">-&gt;</span> <span class="o">{</span><i class="conum" data-value="1"></i><b>(1)</b>
            <span class="k">if</span> <span class="o">(</span><span class="n">realSagaExceptionName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"UserInactiveException"</span><span class="o">))</span> <span class="o">{</span><i class="conum" data-value="2"></i><b>(2)</b>
                <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="n">realException</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"reason"</span><span class="o">).</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">reason</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">reason</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"BadRequest"</span><span class="o">))</span> <span class="o">{</span>
                        <span class="c1">//do the revert process</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can get the <code>RealSagaExceptionName</code> by calling <code>getRealSagaExceptionName()</code> method.
And if you have annotated the exception class with <code>@SagaException</code> annotation when the exception was thrown, it will return a <code>Optional&lt;String&gt;</code> object with the name that has been mentioned in the <code>@SagaException</code> annotation.
Or otherwise, the object will be empty.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>check the equality of Saga exception name with the exception that you want.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>due to that, the exception is the exact same, you can get and check the metadata of the exception that you have given at the moment the exception was thrown.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="saga_revert_hint_store"><a class="anchor" href="#saga_revert_hint_store"></a>5.13. RevertHintStore</h3>
<div class="paragraph">
<p><code>RevertHintStore</code> does provide you a map to put the data that the revert processes want.
After having a <a href="#non_retryable_executor_exception">NonRetryableExecutorException</a>, the engine will start the revert process by stopping to forward anymore.
You know already, when the transaction going forward, you can update or add the data in the aggregator object.
But when it is starting to revert, you cannot change the values in the aggregator object anymore.
Because the aggregator object is frozen.
Therefore, you should have to have a way to carry out the data to the backwards as well.
To overcome that problem, the system provides the RevertHintStore object to add your extra hints that are necessary for the revert process through each executor.
After adding the data in the <code>RevertHintStore</code> object, you can read that data from other next revert-processes.</p>
</div>
<div class="paragraph">
<p>Here you can see an implementation for revert method of one of command executors.
<code>RevertHintStore</code> can be used in all revert processes like <a href="#revert_before_executor">revert-before</a>,
<a href="#revert_after_executor">revert-after</a> executors as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaExecutor</span><span class="o">(</span>
        <span class="n">executeFor</span> <span class="o">=</span> <span class="s">"delivery-service"</span><span class="o">,</span>
        <span class="n">liveCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"DispatchOrderExecutor"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatchOrderExecutor</span> <span class="kd">implements</span> <span class="nc">CommandExecutor</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ProcessStepManager</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="nf">doProcess</span><span class="o">(</span>
            <span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
            <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
            <span class="nc">ProcessStepManagerUtil</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">stepManager</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="o">{</span>
        <span class="c1">//</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doRevert</span><span class="o">(</span><span class="nc">ProcessStack</span> <span class="n">processStack</span><span class="o">,</span>
                         <span class="nc">NonRetryableExecutorException</span> <span class="n">realException</span><span class="o">,</span>
                         <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span><span class="o">,</span>
                         <span class="nc">RevertHintStore</span> <span class="n">revertHintStore</span>
    <span class="o">)</span> <span class="kd">throws</span> <span class="nc">RetryableExecutorException</span> <span class="o">{</span>

        <span class="n">revertHintStore</span>
                <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"MakePaymentExecutor"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">makePaymentExecutor</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">makePaymentExecutor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"success"</span><span class="o">))</span> <span class="o">{</span>
                        <i class="conum" data-value="2"></i><b>(2)</b>
                        <span class="n">revertHintStore</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"last_updated_time"</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
                        <i class="conum" data-value="2"></i><b>(2)</b>
                        <span class="n">revertHintStore</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"DispatchOrderExecutor"</span><span class="o">,</span> <span class="s">"success"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtaining the <code>RevertHintStore</code> data (Key: MakePaymentExecutor) that have been added in another revert process before.
If the value exists in the <code>RevertHintStore</code> you will have an <code>Optional&lt;String&gt;</code> object with the data.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Based on the <code>RevertHintStore</code> 's old data that bes been added by another executor, adding another data into the <code>RevertHintStore</code>.
This value will be helpful for the next revert process.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="saga_event_handler"><a class="anchor" href="#saga_event_handler"></a>5.14. Saga Execution Event Listener </h3>
<div class="paragraph">
<p><code>SagaExecutionEventListener</code> is the place where you&#8217;re notified about each and every action during the process by the SEC.
As an example, you hand over your transaction to the StackSaga engine by mentioning the starting executor.
After handing over, the engine will invoke your executors one by one.
During the process, the engine does provide some events regarding the execution to notify.
To get notified, you can create a separate EventListener classes for each and every <a href="#creating_aggregator_class">Aggregator</a>.
For creating the EventListeners, the EventListeners should be implemented from <code>ExecutionEventListener&lt;A&gt;</code> interface.
<code>A</code> is the Aggregator class that you want to get notified.
And also the class should be annotated with <code><strong>@SagaExecutionEventListener</strong></code>  or <code>@<strong>SagaAsyncExecutionEventListener</strong></code>.
Those annotations provide Spring bean capabilities for your implementation as well.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to call the event methods in <strong>Async-mode</strong>  inside the handler, the handler class can be annotated with <code>@SagaAsyncExecutionEventListener</code> instead of <code>@SagaExecutionEventListener</code>.
Then it will run the event methods in separate threads asynchronously.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure to not use spring <code>@Async</code> annotation with each method inside the listener or the entire class.
Because StackSaga does create a separate thread pool for executing the event methods and also, you can customize it as per the requirements.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ExecutionEventListener&lt;A&gt;</code> provides the following events to be notified.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code><strong>onEachProcessPerformed</strong></code></p>
<div class="ulist">
<ul>
<li>
<p>This method will be invoked after executing each sub process successfully.
— Just think about our example.
After payment process success, the order status should be updated as payment successful and also after successfully dispatched the order, the order status should be updated as order dispatched.
And just think, you want to update your customer by sending an email after the payment process and after dispatching the process.
Handler is the place that you can invoke your processes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code><strong>onEachRevertPerformed</strong></code></p>
<div class="ulist">
<ul>
<li>
<p>This is the opposite of the onEachProcess.
That works after every successful process.
If the whole transaction has to be reverted at some point, the compensation process starts from that point.
Then the revert method of each executed executor starts to be executed as the compensations.
If you want to get notified after each compensation, onEachRevert method will be invoked by the framework with all the data that you want.<br>
According to the example, if the payment process is failed, you have to update the order status as payment failed.
This kind of execution can be proceeded in this method.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code><strong>onTransactionCompleted</strong></code></p>
<div class="ulist">
<ul>
<li>
<p>There are two meanings of transaction-complete.
One is that the transaction was processed without any process exception.
When considering the example the create-order success, user checking is successful, make payment is success, increase point is success, and finally dispatching the order is also success.
The 2nd success is, a process exception was happened and after that all the relevant compensation has been processed successfully.
(That means a revert error hasn&#8217;t been occurred while the compensation process) otherwise we can say the compensation has been processed smoothly without any exceptions.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code><strong>onProcessException</strong></code></p>
<div class="ulist">
<ul>
<li>
<p>This is not relevant to the sub process.
That means the process exception can be happened only one time in the entire process.
When considering the example, you are going to dispatch the order, and it is failed because of non-retryable exception.
(Just think the order is not existing in the database) then the compensation process will be started.
This is the turning point to compensation start.
At that time, this method will be invoked by the framework with the data that you want.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code><strong>onTransactionTerminated</strong></code></p>
<div class="ulist">
<ul>
<li>
<p>According to the flow, any revert process can&#8217;t have non-retryable exception.
That is the rule.
But sometimes the programmer may haven&#8217;t been handled that.
Then the revert process also can&#8217;t be processed anymore.
Then the framework marks that transaction as a garbage transaction and terminates the process.
This is a very rare case.
But it can be happened.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In <code>ExecutionEventListener</code>, all the abstract methods are default.
Therefore, you don&#8217;t want to override all the methods, and you can only override the methods that you want as per the requirement.
And also you can create multiple listeners for the target Aggregator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here you can see an example how you can create a listener of <code>ExecutionEventListener</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@SagaExecutionEventListener</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderEventListener</span> <span class="kd">implements</span> <span class="nc">ExecutionEventListener</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEachProcessPerformed</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">SagaExecutor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Aggregator</span><span class="o">&gt;&gt;</span> <span class="n">processedExecutor</span><span class="o">,</span> <span class="nc">PlaceOrderAggregator</span> <span class="n">currentAggregator</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do whatever you want</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEachRevertPerformed</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">SagaExecutor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Aggregator</span><span class="o">&gt;&gt;</span> <span class="n">revertedExecutor</span><span class="o">,</span> <span class="nc">PlaceOrderAggregator</span> <span class="n">finalAggregatorState</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="n">nonRetryableExecutorException</span><span class="o">,</span> <span class="nc">RevertHintStore</span> <span class="n">revertHintStore</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do whatever you want</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onTransactionCompleted</span><span class="o">(</span><span class="nc">TransactionCompletedDetail</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">transactionCompletedDetail</span><span class="o">,</span> <span class="nc">CompleteStatus</span> <span class="n">completeStatus</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do whatever you want</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onTransactionTerminated</span><span class="o">(</span><span class="nc">TransactionTerminationDetail</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">transactionTerminationDetail</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do whatever you want</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onProcessException</span><span class="o">(</span><span class="nc">PlaceOrderAggregator</span> <span class="n">finalAggregatorState</span><span class="o">,</span> <span class="nc">NonRetryableExecutorException</span> <span class="n">exception</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">SagaExecutor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Aggregator</span><span class="o">&gt;&gt;</span> <span class="n">executorClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//do whatever you want</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="saga_template"><a class="anchor" href="#saga_template"></a>5.15. SagaTemplate&lt;A&gt;</h3>
<div class="paragraph">
<p><code>SagaTemplate</code> is the class which is responsible for starting the StackSaga engine to invoke your transaction.
By providing the necessary data, you can say to start the process of the transaction for StackSaga engine.
<code>SagaTemplate</code> is an instance, and it provides one method called <code>process(&#8230;&#8203;)</code> for starting the process.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>SagaTemplate</code> Is a spring bean that you can Autowire (Injectable) in Spring environment.
You can autowire it by using spring @Autowire annotation or by creating the constructor.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/order"</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceOrderSagaController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SagaTemplate</span><span class="o">&lt;</span><span class="nc">PlaceOrderAggregator</span><span class="o">&gt;</span> <span class="n">sagaTemplate</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="nd">@PostMapping</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">ACCEPTED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">placeOrder</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="nc">PlaceOrderAggregator</span> <span class="n">aggregator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceOrderAggregator</span><span class="o">();</span>
        <span class="n">aggregator</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"mafei"</span><span class="o">);</span>
        <span class="n">aggregator</span><span class="o">.</span><span class="na">setTotal</span><span class="o">(</span><span class="mf">200.00</span><span class="o">);</span>

        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="k">this</span><span class="o">.</span><span class="na">sagaTemplate</span><span class="o">.</span><span class="na">process</span><span class="o">(</span>
                <span class="n">aggregator</span><span class="o">,</span>
                <span class="nc">CheckUserExecutor</span><span class="o">.</span><span class="na">class</span>
        <span class="o">);</span>
        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span>
                <span class="s">"order_id"</span><span class="o">,</span>
                <span class="n">aggregator</span><span class="o">.</span><span class="na">getAggregatorTransactionId</span><span class="o">()</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Autowire(inject) the <code>SagaTemplate</code> by providing the target <a href="#creating_aggregator_class">Aggregator</a> Class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize your aggregator by providing the initial data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the autowired <code>SagaTemplate</code> object and call the <code>process(..)</code> method.
As the first argument, you have to provide the initialized target aggregator object.
As the second argument you have to provide, which is the first executor that should be started the transaction.
According to the example, The 1st executor is <code>CheckUserExecutor.class</code>.
It can be either <a href="#command_executor">Command-Executor</a> or <a href="#query_executor">Query-Executor</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns the response by obtaining the aggregatorTransactionId from the initialized object.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Due to the fact that the target aggregator class has been extended from the <code>Aggregator</code>, you can use inherited methods from <code>Aggregator</code> class.
The <code>getAggregatorTransactionId()</code> method is one of inherited methods from <code>Aggregator</code> class.
It will provide you the <strong>unique ID</strong> for each object (each transaction) that you initialize.
It will be the transaction id for the entire transaction.
</td>
</tr>
</table>
</div>
<hr>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Even though <code>SagaTemplate&lt;A&gt;</code> can be autowired anywhere in the application, As the best practice it is recommended to use <code>SagaTemplate&lt;A&gt;</code> inside of an <code>EventHandler</code> class according to the StackSaga design pattern called <a href="#test">CHES</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="saga_trash_listener"><a class="anchor" href="#saga_trash_listener"></a>5.16. TrashFileListener</h3>
<div class="paragraph">
<p><code>TrashFileListener</code> is used to be notified about the <strong>Trash-Files</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom_thread_pool_configuration"><a class="anchor" href="#custom_thread_pool_configuration"></a>5.17. Custom Thread-pool configuration</h3>
<div class="paragraph">
<p>In StackSaga framework, there are several thread-pools are used behind the scene with default configurations.
All the executions are not executed with a single thread-pool to ensure the resiliency of the application.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Thread-pools in StackSaga framework</caption>
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1112%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">pool-name</th>
<th class="tableblock halign-left valign-top">Provider Interface</th>
<th class="tableblock halign-left valign-top">dependency</th>
<th class="tableblock halign-left valign-top">default-implementation</th>
<th class="tableblock halign-left valign-top">prefix</th>
<th class="tableblock halign-left valign-top">core pool size</th>
<th class="tableblock halign-left valign-top">max pool size</th>
<th class="tableblock halign-left valign-top">Queue Capacity</th>
<th class="tableblock halign-left valign-top">WaitOnShutdown</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#saga_discovery_transaction_task_executor"><code>SagaDiscoveryTransactionTaskExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaDiscoveryTransactionTaskExecutorProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><code>stacksaga-spring-boot-starter-core</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaDiscoveryTransactionTaskExecutorProviderDefault</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><strong>saga-tx-</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 3</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#saga_event_task_executor"><code>SagaEventTaskExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaEventTaskExecutorProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><code>stacksaga-spring-boot-starter-core</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaEventExecutorProviderDefault</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><strong>saga-event-</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#saga_admin_task_executor"><code>SagaAdminTaskExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaAdminTaskExecutorProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><code>stacksaga-spring-boot-starter-discovery</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaAdminTaskExecutorProviderDefault</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><strong>saga-admin-</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#saga_discovery_file_task_executor"><code>SagaDiscoveryFileTaskExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaDiscoveryFileTaskExecutorProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><code>stacksaga-spring-boot-starter-discovery</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaDiscoveryFileTaskExecutorProviderDefault</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><strong>saga-file-</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#saga_discovery_retry_transaction_task_executor"><code>SagaDiscoveryRetryTransactionTaskExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaDiscoveryRetryTransactionTaskExecutorProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><code>stacksaga-spring-boot-starter-discovery</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SagaDiscoveryRetryTransactionTaskExecutorProviderDefault</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap"><strong>saga-R-tx-</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="nowrap">Available Processors * 2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In case if you want to change the default configuration, you can do it by implementing following</p>
</div>
<div class="sect3">
<h4 id="saga_discovery_transaction_task_executor"><a class="anchor" href="#saga_discovery_transaction_task_executor"></a>5.17.1. Saga Discovery Transaction TaskExecutor</h4>
<div class="paragraph">
<p><code>SagaDiscoveryTransactionTaskExecutor</code> is the main pool. because this thread-pool is used for starting your transaction when it is called the <a href="#saga_template"><code>SagaTemplate.process()</code></a> method. after starting the transaction, this thread-pool will handle all the executions of the executors.</p>
</div>
<div class="paragraph">
<p>— In case if you want to customize the default configuration, you can update the default configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomSagaDiscoveryTransactionTaskExecutor</span>
    <span class="kd">implements</span> <span class="nc">SagaDiscoveryTransactionTaskExecutorProvider</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ThreadPoolTaskExecutor</span> <span class="nf">getTaskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">*</span> <span class="mi">5</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark the class as a spring <code>@Component</code> (bean).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the custom task-executor provider class from <code>SagaDiscoveryTransactionTaskExecutorProvider</code> and override the <code>getTaskExecutor()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide your custom task-executor configurations by creating a new instance of <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html"><code>ThreadPoolTaskExecutor</code></a>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though you change the prefix of the thread-pool when the task-executor is created, the prefix is restored for maintaining the thread-name uniqueness. <a href="#custom_thread_pool_configuration">See the prefix of each thread-pool</a>.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="saga_event_task_executor"><a class="anchor" href="#saga_event_task_executor"></a>5.17.2. Saga Event TaskExecutor</h4>
<div class="paragraph">
<p>— In case if you want to customize the default configuration, you can update the default configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomSagaEventTaskExecutor</span> <span class="kd">implements</span> <span class="nc">SagaEventTaskExecutorProvider</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ThreadPoolTaskExecutor</span> <span class="nf">getTaskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">*</span> <span class="mi">5</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark the class as a spring <code>@Component</code> (bean).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the custom task-executor provider class from <code>SagaEventTaskExecutorProvider</code> and override the <code>getTaskExecutor()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide your custom task-executor configurations by creating a new instance of <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html"><code>ThreadPoolTaskExecutor</code></a>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though you change the prefix of the thread-pool when the task-executor is created, the prefix is restored for maintaining the thread-name uniqueness. <a href="#custom_thread_pool_configuration">See the prefix of each thread-pool</a>.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="saga_admin_task_executor"><a class="anchor" href="#saga_admin_task_executor"></a>5.17.3. Saga Admin TaskExecutor</h4>
<div class="paragraph">
<p>— In case if you want to customize the default configuration, you can update the default configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomSagaAdminTaskExecutor</span>
    <span class="kd">implements</span> <span class="nc">SagaAdminTaskExecutorProvider</span> <span class="o">{</span><i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ThreadPoolTaskExecutor</span> <span class="nf">getTaskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">*</span> <span class="mi">5</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark the class as a spring <code>@Component</code> (bean).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the custom task-executor provider class from <code>SagaAdminTaskExecutorProvider</code> and override the <code>getTaskExecutor()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide your custom task-executor configurations by creating a new instance of <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html"><code>ThreadPoolTaskExecutor</code></a>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though you change the prefix of the thread-pool when the task-executor is created, the prefix is restored for maintaining the thread-name uniqueness. <a href="#custom_thread_pool_configuration">See the prefix of each thread-pool</a>.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="saga_discovery_file_task_executor"><a class="anchor" href="#saga_discovery_file_task_executor"></a>5.17.4. Saga Discovery File TaskExecutor</h4>
<div class="paragraph">
<p>— In case if you want to customize the default configuration, you can update the default configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomSagaDiscoveryFileTaskExecutor</span>
    <span class="kd">implements</span> <span class="nc">SagaDiscoveryFileTaskExecutorProvider</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ThreadPoolTaskExecutor</span> <span class="nf">getTaskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">*</span> <span class="mi">5</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark the class as a spring <code>@Component</code> (bean).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the custom task-executor provider class from <code>SagaDiscoveryFileTaskExecutorProvider</code> and override the <code>getTaskExecutor()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide your custom task-executor configurations by creating a new instance of <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html"><code>ThreadPoolTaskExecutor</code></a>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though you change the prefix of the thread-pool when the task-executor is created, the prefix is restored for maintaining the thread-name uniqueness. <a href="#custom_thread_pool_configuration">See the prefix of each thread-pool</a>.
</td>
</tr>
</table>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="saga_discovery_retry_transaction_task_executor"><a class="anchor" href="#saga_discovery_retry_transaction_task_executor"></a>5.17.5. Saga Discovery Retry Transaction TaskExecutor</h4>
<div class="paragraph">
<p>Even though the transaction is started by the <a href="#saga_discovery_transaction_task_executor"><code>SagaDiscoveryTransactionTaskExecutor</code></a>
thread-pool, if the transaction is paused due a <a href="#retryable_executor_exception"><code>RetryableExecutorException</code></a>, the transaction should be retried again after some time (configured schedule).
For those executions, the <code>SagaDiscoveryRetryTransactionTaskExecutor</code> thread-pool is used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It ensures the application&#8217;s resiliency.
And also the application can receive the new transaction without interrupting the transaction retry-bulk.
The summary is that the retry execution does not disturb to the brand-new transaction.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>— In case if you want to customize the default configuration, you can update the default configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomSagaDiscoveryRetryTransactionTaskExecutor</span>
    <span class="kd">implements</span> <span class="nc">SagaDiscoveryRetryTransactionTaskExecutorProvider</span> <span class="o">{</span><i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ThreadPoolTaskExecutor</span> <span class="nf">getTaskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">*</span> <span class="mi">5</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark the class as a spring <code>@Component</code> (bean).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the custom task-executor provider class from <code>SagaDiscoveryRetryTransactionTaskExecutorProvider</code> and override the <code>getTaskExecutor()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide your custom task-executor configurations by creating a new instance of <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html"><code>ThreadPoolTaskExecutor</code></a>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though you change the prefix of the thread-pool when the task-executor is created, the prefix is restored for maintaining the thread-name uniqueness. <a href="#custom_thread_pool_configuration">See the prefix of each thread-pool</a>.
</td>
</tr>
</table>
</div>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="connect_admin"><a class="anchor" href="#connect_admin"></a>5.18. Connect Admin</h3>
<div class="paragraph">
<p>As per the architecture, all the StackSaga clients connect to the StackSaga admin server initially (<strong>for submitting the instance metadata</strong>) and as well as during the StackSaga-client is being run (<strong>for submitting the terminated transaction data</strong>).</p>
</div>
<div class="paragraph">
<p>IF you want to connect your service with the StackSaga admin server, you have to have a <strong>service-account</strong> that has been created by the StackSaga admin.
IF you have a <strong>service-account</strong>, you can provide your service-account username and password for the basic authentication purpose.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the microservice architecture, you will have hundreds of instances running on.
It is enough to have a one service-account for one service-name.
(The <code>spring.application.name</code> is considered as the service-name.)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After creating the <code>service-account</code>, you will have the basic authentication for the registered service.
Those basic authentication can be provided as follows in the configuration property file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="properties"><span class="py">stacksaga.connect.admin-url</span><span class="p">=</span><span class="s">http://localhost:4444</span>
<span class="py">stacksaga.connect.admin-username</span><span class="p">=</span><span class="s">order-service</span>
<span class="py">stacksaga.connect.admin-password</span><span class="p">=</span><span class="s">*****************</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default StackSaga-Admin-server running on port <strong>4444</strong>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="custom_admin_connect_resttemplate_configuration"><a class="anchor" href="#custom_admin_connect_resttemplate_configuration"></a>5.18.1. Custom Admin Connector configuration</h4>
<div class="paragraph">
<p>In addition to the default configurations, if you want to provide more complex configurations for the http client (RestTemplate) like enable custom SSL configurations, You can provide your own <code>RestTemplate</code> for the StackSaga framework to use when the client connects to the admin-server.
Then the default configuration (<code>SagaAdminConnectRestTemplateProviderDefault</code>) will be overridden with your custom configurations.</p>
</div>
<div class="paragraph">
<p>— you can provide your custom configuration like below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAdminConnectRestTemplate</span> <span class="kd">implements</span> <span class="nc">SagaAdminConnectRestTemplateProvider</span> <span class="o">{</span><i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">RestTemplate</span> <span class="nf">getRestTemplate</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nc">RestTemplate</span> <span class="n">restTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RestTemplate</span><span class="o">();</span>
        <span class="c1">//provide your custom configurations</span>
        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>CustomAdminConnectRestTemplate</code> class with spring <code>@Component</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the custom RestTemplate provider class from <code>SagaAdminConnectRestTemplateProvider</code> and override the <code>getRestTemplate()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide the custom RestTemplate with your own configurations.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure to add the <code>rootUri</code> of the Admin-server to the new restTemplate.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to get the admin-server connection configuration from the configuration file for your <code>CustomAdminConnectRestTemplate</code> class, you can autowire <code>StackSagaAdminConfiguration</code> and get the configurations from it.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service_communication"><a class="anchor" href="#service_communication"></a>5.19. Internal Service Communication</h3>
<div class="paragraph">
<p>As per the StackSaga architecture, Internally (<strong>within the same zone</strong>) each instance should be able to communicate with other instances at any time.
Because, Any instance can be the Master instance and then the Master instance should have to make requests to other slaves to notify the retry-allocations.
The communication is done by based on the service registry cache of the current master.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Nature of Communication: If your microservices communicate with each other only within a trusted network (such as an internal data center with <a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">VPC network</a>), the need for SSL might be reduced.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="eureka_configuration_for_stacksaga"><a class="anchor" href="#eureka_configuration_for_stacksaga"></a>5.19.1. Eureka configuration for StackSaga</h4>
<div class="paragraph">
<p>If you ara using <code>stacksaga-spring-boot-starter-discovery</code>, To communicate with the slaves, the master instance uses a <code>RestTemplate</code> internally with the following configurations.</p>
</div>
<div class="paragraph">
<p>— Here you can see the required configurations with default values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="properties"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="py">eureka.instance.metadata-map.stacksagaManagementScheme</span><span class="p">=</span><span class="s">http</span>
<i class="conum" data-value="2"></i><b>(2)</b>
<span class="py">eureka.instance.metadata-map.stacksagaManagementBasePath</span><span class="p">=</span><span class="s">/actuator</span>
<i class="conum" data-value="3"></i><b>(3)</b>
<span class="py">eureka.instance.metadata-map.stacksagaRegion</span><span class="p">=</span><span class="s">defaultRegion</span>
<i class="conum" data-value="4"></i><b>(4)</b>
<span class="py">eureka.instance.metadata-map.stacksagaZone</span><span class="p">=</span><span class="s">defaultZone</span>
<i class="conum" data-value="5"></i><b>(5)</b>
<span class="py">eureka.instance.metadata-map.stacksagaManagementPort</span><span class="p">=</span><span class="s">0</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>stacksagaManagementScheme</strong>: Scheme of the management service.
<div class="paragraph">
<p>The default value is <strong>http</strong>.
If you want to enable <strong>https</strong>, you have to provide it through the configuration here.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>stacksagaManagementBasePath</strong>: Base path of the management service.
<div class="paragraph">
<p>The default value is <strong>/actuator</strong>.
If you change the default value of the actuator(<code>management.endpoints.web.base-path</code>), make sure to provide it for Stacksaga as well.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>stacksagaRegion</strong>: Which is the region that the instance is currently running on.
The default value is <strong>defaultRegion</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>stacksagaZone</strong>: Which is the zone that the instance is currently running on.
The default value is <strong>defaultZone</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>stacksagaManagementPort</strong>: The management service port.
If you change the default management port in actuator (<code>management.server.port</code>) you have to provide it for Stacksaga as well.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the server port and the management service port will be the same in spring.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="custom_service_communication_resttemplate_configuration"><a class="anchor" href="#custom_service_communication_resttemplate_configuration"></a>5.19.1.1. Custom Service Communication configuration</h5>
<div class="paragraph">
<p>In case if you want to have more complex configurations more than default configurations like enabling custom SSL, adding authentication, you can provide your own RestTemplate for the framework like below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><span class="nd">@Component</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServiceCommunicationRestTemplate</span> <span class="kd">implements</span> <span class="nc">SagaServiceCommunicationRestTemplateProvider</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RestTemplateBuilder</span> <span class="n">restTemplateBuilder</span><span class="o">;</span>

    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">RestTemplate</span> <span class="nf">getRestTemplate</span><span class="o">()</span> <span class="o">{</span>
        <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="c1">//provide your custom configurations</span>
        <span class="nc">RestTemplate</span> <span class="n">restTemplate</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">restTemplateBuilder</span>
                <span class="o">...</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate your custom class as a spring been with <code>@Component</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the custom class from <code>SagaServiceCommunicationRestTemplateProvider</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Override the <code>getRestTemplate()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Provide your <code>RestTemplate</code> with your own custom configurations.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure to not provide <code>rootUri</code> with your <code>RestTemplate</code> configurations.
Because the URL is built based on the <a href="#eureka_configuration_for_stacksaga">configuration properties</a> and Eureka service-registry internally.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stacksaga_starter_db_index"><a class="anchor" href="#stacksaga_starter_db_index"></a>6. StackSaga Starter DB</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="stacksaga_starter_discovery_index"><a class="anchor" href="#stacksaga_starter_discovery_index"></a>7. StackSaga Starter Discovery</h2>
<div class="sectionbody">

</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-09-12 01:07:49 +0530
</div>
</div>
</body>
</html>
